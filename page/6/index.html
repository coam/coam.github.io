<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>商运物流</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="商运物流">
<meta property="og:url" content="https://coam.co/page/6/index.html">
<meta property="og:site_name" content="商运物流">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="商运物流">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="商运物流" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    
    
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: true,
          isPost: false,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/author.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">张亚飞</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:zyf@lonal.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/zyfmix" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/markdown-gfw-hexo-jekyll/" style="font-size: 10px;">markdown gfw hexo jekyll</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://coam.co">商运物流</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/zyfmix/">GitHub</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://wp.iirii.com/">商运技术博客</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于物流设计</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">张亚飞</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img lazy-src="/img/author.jpg" class="js-avatar">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">张亚飞</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:zyf@lonal.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/zyfmix" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Java/LearnAsyncTask" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/Java/LearnAsyncTask/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/Java/LearnAsyncTask/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h4 id="Android-开发之-AsyncTask-异步任务"><a href="#Android-开发之-AsyncTask-异步任务" class="headerlink" title="Android 开发之 AsyncTask 异步任务"></a>Android 开发之 AsyncTask 异步任务</h4><p><a href="http://code.oneapm.com/android/2015/06/02/android1/" target="_blank" rel="external">Android开发者:你真的会用AsyncTask吗?</a><br><a href="http://stackvoid.com/understanding-AsyncTask-in-Android/" target="_blank" rel="external">深入理解AsyncTask</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-NodeJs/NodeJsNote" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/NodeJs/NodeJsNote/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/NodeJs/NodeJsNote/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Node-js-Note"><a href="#Node-js-Note" class="headerlink" title="Node.js Note"></a>Node.js Note</h1><h4 id="Node-js-和-Socket-io-搭建消息实时推送"><a href="#Node-js-和-Socket-io-搭建消息实时推送" class="headerlink" title="Node.js 和 Socket.io 搭建消息实时推送"></a>Node.js 和 Socket.io 搭建消息实时推送</h4><p>参考 <a href="http://www.jianshu.com/p/d9b1273a93fd" target="_blank" rel="external">http://www.jianshu.com/p/d9b1273a93fd</a><br>参考 <a href="http://socket.io/" target="_blank" rel="external">http://socket.io/</a><br>参考 <a href="http://segmentfault.com/a/1190000000382788" target="_blank" rel="external">http://segmentfault.com/a/1190000000382788</a><br>参考 <a href="http://segmentfault.com/blog/jiyinyiyong/1190000000453817" target="_blank" rel="external">http://segmentfault.com/blog/jiyinyiyong/1190000000453817</a><br>参考 <a href="http://www.oseye.net/user/kevin/blog/83" target="_blank" rel="external">http://www.oseye.net/user/kevin/blog/83</a><br>参考 <a href="http://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="external">http://zh.wikipedia.org/wiki/WebSocket</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-MongoDB/mongo-slave" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/MongoDB/mongo-slave/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/MongoDB/mongo-slave/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="MongoDB-主动复制"><a href="#MongoDB-主动复制" class="headerlink" title="MongoDB 主动复制"></a>MongoDB 主动复制</h2><p>参考 <a href="http://www.lanceyan.com/tech/mongodb/mongodb_cluster_1.html" target="_blank" rel="external">http://www.lanceyan.com/tech/mongodb/mongodb_cluster_1.html</a><br>参考 <a href="http://segmentfault.com/a/1190000002924522" target="_blank" rel="external">MongoDB学习札记第六篇之主从复制</a><br>参考 <a href="http://www.jianshu.com/p/2825a66d6aed" target="_blank" rel="external">高可用的MongoDB集群</a></p>
<blockquote>
<p>在大数据的时代,传统的关系型数据库要能更高的服务必须要解决高并发读写、海量数据高效存储、高可扩展性和高可用性这些难题.不过就是因为这些问题Nosql诞生了.</p>
</blockquote>
<p>NOSQL有这些优势:</p>
<p>大数据量,可以通过廉价服务器存储大量的数据,轻松摆脱传统mysql单表存储量级限制.</p>
<p>高扩展性,Nosql去掉了关系数据库的关系型特性,很容易横向扩展,摆脱了以往老是纵向扩展的诟病.</p>
<p>高性能,Nosql通过简单的key-value方式获取数据,非常快速.还有NoSQL的Cache是记录级的,是一种细粒度的Cache,所以NoSQL在这个层面上来说就要性能高很多.</p>
<p>灵活的数据模型,NoSQL无需事先为要存储的数据建立字段,随时可以存储自定义的数据格式.而在关系数据库里,增删字段是一件非常麻烦的事情.如果是非常大数据量的表,增加字段简直就是一个噩梦.</p>
<p>高可用,NoSQL在不太影响性能的情况,就可以方便的实现高可用的架构.比如mongodb通过mongos、mongo分片就可以快速配置出高可用配置.</p>
<p>在nosql数据库里,大部分的查询都是键值对（key、value）的方式.MongoDB是一个介于关系数据库和非关系数据库之间的产品,是非关系数据库当中最像关系数据库的.支持类似于面向对象的查询语言,几乎可以实现类似关系数据库单表查询的绝大部分功能,而且还支持对数据建立索引.所以这个非常方便,我们可以用sql操作MongoDB,从关系型数据库迁移过来,开发人员学习成本会大大减少.如果再对底层的sql API做一层封装,开发基本可以感觉不到mongodb和关系型数据库的区别.同样MongoDB也是号称自己能够快速搭建一个高可用可扩展的的分布式集群,网上有很多搭建的文章,在我们搭建的时候还需要查找修改很多东西,所以把自己实战的步骤记录下来以备忘.我们看看如何一步一步搭建这个东东.</p>
<p>一、mongodb单实例.这种配置只适合简易开发时使用,生产使用不行,因为单节点挂掉整个数据业务全挂,如下图.<br>虽然不能生产使用,但这个模式可以快速搭建启动,并且能够用mongodb的命令操作数据库.下面列出在linux下安装单节点mongodb的步骤</p>
<p>二、主从模式.使用mysql数据库时大家广泛用到,采用双机备份后主节点挂掉了后从节点可以接替主机继续服务.所以这种模式比单节点的高可用性要好很多.<br>下面看一下怎么一步步搭建一个mongodb的主从复制节点:<br>1、准备两台机器 43.241.222.110 和 42.96.194.60. 43.241.222.110 当作主节点, 42.96.194.60作为从节点.<br>2、分别下载 mongodb 安装程序包.在 43.241.222.110 上建立文件夹 /home/data/mongodb,42.96.194.60 建立文件夹 /home/data/mongodb<br>两台MongoDB服务器的配置文件均为 /etc/mongod.cnf</p>
<pre><code>storage:
    dbPath: &quot;/data/home/data/mongodb&quot;
    engine: wiredTiger
    wiredTiger:
        engineConfig:
            cacheSizeGB: 20
        collectionConfig:
            blockCompressor: snappy

systemLog:
   destination: file
   path: &quot;/var/log/mongodb/mongod.log&quot;
   logAppend: true

processManagement:
    fork: true

net:
    #bindIp: 127.0.0.1,43.241.222.110,42.96.194.60  不能绑定外网访问ip,局域网的貌似可以,只能在iptable设定允许指定ip访问27017
    #bindIp: 0.0.0.0
    port: 27017
    # Enable the HTTP interface (Defaults to port 28017).
    http:
        enabled: false
</code></pre><p>3、在43.241.222.110启动mongodb主节点程序.注意后面的这个 “-master”参数,标示主节点.启动主节点 </p>
<pre><code>sudo mongod -f /etc/mongod.cnf -master
</code></pre><p>4、在42.96.194.60启动 mongodb 从节点程序.关键配置,指定主节点ip地址和端口 -source 43.241.222.110:27017 和 标示从节点 -slave 参数.</p>
<pre><code>sudo mongod -f /etc/mongod.cnf -slave -source 43.241.222.110:27017
</code></pre><p>输出日志如下,成功！</p>
<p>#日志显示从节点 从主节点同步复制数据</p>
<pre><code>[replslave] repl: from host:43.241.222.110:27017
</code></pre><p>配置完Mongo主从复制后开始测试主从复制.</p>
<p>在主节点上连接到终端:</p>
<pre><code>mongo 127.0.0.1
</code></pre><p>#建立test 数据库.</p>
<pre><code>use test;
</code></pre><p>往testdb表插入数据.</p>
<pre><code>&gt; db.testdb.insert({&quot;test1&quot;:&quot;testval1&quot;})
</code></pre><p>查询testdb数据看看是否成功.</p>
<pre><code>&gt; db.testdb.find();
{ &quot;_id&quot; : ObjectId(&quot;5284e5cb1f4eb215b2ecc463&quot;), &quot;test1&quot; : &quot;testval1&quot; }
</code></pre><p>检查从主机的数据.</p>
<pre><code>mongo 127.0.0.1
</code></pre><p>查看当前数据库.</p>
<pre><code>&gt; show dbs;
  local   0.203125GB
  test    0.203125GB

use test;
db.testdb.find();
{ &quot;_id&quot; : ObjectId(&quot;5284e5cb1f4eb215b2ecc463&quot;), &quot;test1&quot; : &quot;testval1&quot; }
</code></pre><p>查询后数据已经同步过来了.再看看日志,发现从主机确实从主机同步了数据.</p>
<p>查看服务状态</p>
<pre><code>&gt; db.printReplicationInfo();
this is a slave, printing slave replication info.
source:   43.241.222.110:27017
  syncedTo: Sun Nov 17 2013 16:04:02 GMT+0800 (CST) = -54 secs ago (-0.01hrs)
</code></pre><p>到此主从结构的mongodb搭建好了.</p>
<p>参考 <a href="http://segmentfault.com/a/1190000002924522" target="_blank" rel="external">MongoDB学习札记第六篇之主从复制</a></p>
<p><a href="http://dev.guanghe.tv/2015/05/mongdb3-upgrade-bug.html" target="_blank" rel="external">MongoDB 3.0 复制集升级操作以及坑</a></p>
<hr>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>进入MongoShell执行以下命令</p>
<pre><code>&gt;show dbs
</code></pre><p>提示以下错误</p>
<pre><code>E QUERY Error: listDatabases failed: 
        { &quot;note&quot; : &quot;from execCommand&quot;, &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not master&quot; }
at Error (&lt;anonymous&gt;)
</code></pre><p>查看mongo状态</p>
<pre><code>&gt; rs.status()
{ &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not running with --replSet&quot;, &quot;code&quot; : 76 }
</code></pre><p>每次登陆mongoShell后都需要执行以下命令</p>
<pre><code>&gt; rs.slaveOK()
2015-09-24T17:03:16.528+0800 E QUERY    TypeError: Object function () { return &quot;try rs.help()&quot;; } has no method &apos;slaveOK&apos;    at (shell):1:4
</code></pre><p>参考 MongoDB 3.0 复制集升级操作以及坑 <a href="http://dev.guanghe.tv/2015/05/mongdb3-upgrade-bug.html" target="_blank" rel="external">http://dev.guanghe.tv/2015/05/mongdb3-upgrade-bug.html</a></p>
<p>//查看状态</p>
<pre><code>&gt; rs.status()
{ &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not running with --replSet&quot;, &quot;code&quot; : 76 }
</code></pre><p>查看运行时配置</p>
<pre><code>&gt; use admin
switched to db admin
&gt; db.runCommand(&quot;getCmdLineOpts&quot;)
{
    &quot;argv&quot; : [
        &quot;mongod&quot;,
        &quot;-f&quot;,
        &quot;/etc/mongod.cnf&quot;,
        &quot;-slave&quot;,
        &quot;-source&quot;,
        &quot;43.241.222.110:27017&quot;
    ],
    &quot;parsed&quot; : {
        &quot;config&quot; : &quot;/etc/mongod.cnf&quot;,
        &quot;net&quot; : {
            &quot;http&quot; : {
                &quot;enabled&quot; : false
            },
            &quot;port&quot; : 27017
        },
        &quot;processManagement&quot; : {
            &quot;fork&quot; : true
        },
        &quot;slave&quot; : true,
        &quot;source&quot; : &quot;43.241.222.110:27017&quot;,
        &quot;storage&quot; : {
            &quot;dbPath&quot; : &quot;/data/home/data/mongodb&quot;,
            &quot;engine&quot; : &quot;wiredTiger&quot;,
            &quot;wiredTiger&quot; : {
                &quot;collectionConfig&quot; : {
                    &quot;blockCompressor&quot; : &quot;snappy&quot;
                },
                &quot;engineConfig&quot; : {
                    &quot;cacheSizeGB&quot; : 20
                }
            }
        },
        &quot;systemLog&quot; : {
            &quot;destination&quot; : &quot;file&quot;,
            &quot;logAppend&quot; : true,
            &quot;path&quot; : &quot;/var/log/mongodb/mongod.log&quot;
        }
    },
    &quot;ok&quot; : 1
}
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-MongoDB/mongo-replicaSet" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/MongoDB/mongo-replicaSet/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/MongoDB/mongo-replicaSet/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="MongoDB-复制集"><a href="#MongoDB-复制集" class="headerlink" title="MongoDB 复制集"></a>MongoDB 复制集</h3><p>参考 <a href="http://www.codefrom.com/paper/MongoDB%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0%E7%AC%AC%E5%85%AB%E7%AF%87%E4%B9%8BReplica%20Set%20%E5%AE%9E%E6%88%98" target="_blank" rel="external">MongoDB学习札记第八篇之Replica Set 实战</a><br>参考 <a href="http://www.putaor.com/?p=577" target="_blank" rel="external">MongoDB 3.0 复制集集群搭建及安全认证实践</a><br>参考 <a href="http://www.mongoing.com/config_3_0" target="_blank" rel="external">MongoDB 3.0 WT引擎参考配置文件</a><br>参考 <a href="http://www.cnblogs.com/zhoujinyi/p/3554010.html" target="_blank" rel="external">MongoDB 副本集的原理、搭建、应用</a></p>
<p>准备三台mongo服务器 分别为 43.241.222.110 42.96.194.60 和 45.63.50.67 搭建复制集</p>
<p>如果对于怎么安装Mongodb还不清楚的同学可以查看我之前的学习札记</p>
<p>三台MongoDB服务器的配置文件均为 /etc/mongod.cnf</p>
<pre><code>storage:
    dbPath: &quot;/data/home/data/RSMongoDB&quot;
    engine: wiredTiger
    wiredTiger:
        engineConfig:
            cacheSizeGB: 20
        collectionConfig:
            blockCompressor: snappy

systemLog:
   destination: file
   path: &quot;/var/log/mongodb/mongod.log&quot;
   logAppend: true

processManagement:
    fork: true

net:
    #bindIp: 127.0.0.1,43.241.222.110,42.96.194.60  不能绑定外网访问ip,局域网的貌似可以,只能在iptable设定允许指定ip访问27017
    #bindIp: 0.0.0.0
    port: 27017
    # Enable the HTTP interface (Defaults to port 28017).
    http:
        enabled: false
</code></pre><p>第一步:</p>
<p>在三台机器上分别运行（都要运行）</p>
<pre><code>root@ubuntu:/usr/local/mongodb#mongod -f /etc/mongod.cnf --replSet CoamReSet
</code></pre><p>注意这里的 —replSet 参数指定了副本集的名称,每一个副本集都有一个唯一的名称.</p>
<p>等到三台机器都启动完了之后.使用mongo客户端登录其中一台mongod服务器.这里我登录到 43.241.222.110 这台机器</p>
<pre><code>root@ubuntu:~# mongo
</code></pre><p>登录之后要切换到admin数据库,这样我们可以进行副本集的配置,具体怎么配置,代码如下:</p>
<pre><code>&gt; use admin
switched to db admin
</code></pre><p>定义副本集配置变量,这里的 _id:”repset” 和上面命令参数 “ –replSet repset” 要保持一样.</p>
<pre><code>&gt; config = {_id:&quot;CoamReSet&quot;,members:[
         {_id:0,host:&quot;43.241.222.110:27017&quot;,&quot;priority&quot;:1},
         {_id:1,host:&quot;42.96.194.60:27017&quot;,&quot;priority&quot;:1},
         {_id:2,host:&quot;45.63.50.67:27017&quot;,&quot;priority&quot;:0}]}
</code></pre><h4 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h4><pre><code>{
    &quot;_id&quot; : &quot;CoamReSet&quot;,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 0,
            &quot;host&quot; : &quot;43.241.222.110:27017&quot;
        },
        {
            &quot;_id&quot; : 1,
            &quot;host&quot; : &quot;42.96.194.60:27017&quot;
        },
        {
            &quot;_id&quot; : 2,
            &quot;host&quot; : &quot;45.63.50.67:27017&quot;
        }
    ]
}
</code></pre><h4 id="初始化副本集配置"><a href="#初始化副本集配置" class="headerlink" title="初始化副本集配置"></a>初始化副本集配置</h4><pre><code>&gt; rs.initiate(config);
</code></pre><h4 id="输出成功"><a href="#输出成功" class="headerlink" title="输出成功"></a>输出成功</h4><pre><code>{ &quot;ok&quot; : 1 }
</code></pre><h4 id="注意-新创建副本集必须要数据库没有数据-否则初始化会提示以下错误"><a href="#注意-新创建副本集必须要数据库没有数据-否则初始化会提示以下错误" class="headerlink" title="注意:新创建副本集必须要数据库没有数据,否则初始化会提示以下错误:"></a>注意:新创建副本集必须要数据库没有数据,否则初始化会提示以下错误:</h4><pre><code>{
    &quot;ok&quot; : 0,
    &quot;errmsg&quot; : &quot;&apos;42.96.194.60:27017&apos; has data already, cannot initiate set.&quot;,
    &quot;code&quot; : 110
}
</code></pre><p>先定义 config 的配置信息, 然后通过 rs.initiate(config) 方法,将配置信息初始化.这两个步骤完成之后就表示我们的副本集配置信息初始化完成了,在这个CoamReSet的副本集中我们定义了三台主机（注意在定义配置信息的时候指定的 _id 必须和我们启动mongod的时候指定的参数 —replSet 这个参数的值是一样的.）</p>
<p>过一会,mongodb就会帮我们选举出Primary节点和Secondary节点了.那在mongo客户端,我们可以通过 rs.status() 来查看副本集的状态信息</p>
<pre><code>CoamReSet:SECONDARY&gt; rs.status()
{
    &quot;set&quot; : &quot;CoamReSet&quot;,
    &quot;date&quot; : ISODate(&quot;2015-10-01T09:45:34.924Z&quot;),
    &quot;myState&quot; : 1,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 0,
            &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 1,
            &quot;stateStr&quot; : &quot;PRIMARY&quot;,
            &quot;uptime&quot; : 167,
            &quot;optime&quot; : Timestamp(1443692712, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T09:45:12Z&quot;),
            &quot;electionTime&quot; : Timestamp(1443692715, 1),
            &quot;electionDate&quot; : ISODate(&quot;2015-10-01T09:45:15Z&quot;),
            &quot;configVersion&quot; : 1,
            &quot;self&quot; : true
        },
        {
            &quot;_id&quot; : 1,
            &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 21,
            &quot;optime&quot; : Timestamp(1443692712, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T09:45:12Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T09:45:33.166Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T09:45:33.564Z&quot;),
            &quot;pingMs&quot; : 16,
            &quot;configVersion&quot; : 1
        },
        {
            &quot;_id&quot; : 2,
            &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 21,
            &quot;optime&quot; : Timestamp(1443692712, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T09:45:12Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T09:45:32.949Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T09:45:33.973Z&quot;),
            &quot;pingMs&quot; : 183,
            &quot;configVersion&quot; : 1
        }
    ],
    &quot;ok&quot; : 1
}
</code></pre><p>其中name表示我么你的主机, health表示主机是否健康（0/1） , state（主节点(1)还是从节点(2),或者是不可达节点)</p>
<p>如果上面信息正常显示出来说明整个副本集群已经建立起来了.这时候我们来验证一下是否是真的能够自动备份数据,是否能够自动从失败中恢复,自动选举新的Primary节点.<br>这个实验我们这样来做:</p>
<h4 id="先往-Primary-节点（43-241-222-110）插入数据-在-42-96-194-60-和-45-63-50-67-两台-Secondary-节点中查询数据-验证是否能够正常的同步机器"><a href="#先往-Primary-节点（43-241-222-110）插入数据-在-42-96-194-60-和-45-63-50-67-两台-Secondary-节点中查询数据-验证是否能够正常的同步机器" class="headerlink" title="先往 Primary 节点（43.241.222.110）插入数据,在 42.96.194.60 和 45.63.50.67 两台 Secondary 节点中查询数据,验证是否能够正常的同步机器."></a>先往 Primary 节点（43.241.222.110）插入数据,在 42.96.194.60 和 45.63.50.67 两台 Secondary 节点中查询数据,验证是否能够正常的同步机器.</h4><blockquote>
<p>先往 Primary 节点（43.241.222.110）插入数据</p>
</blockquote>
<pre><code>CoamReSet:PRIMARY&gt; use test
switched to db test
CoamReSet:PRIMARY&gt; show collections
CoamReSet:PRIMARY&gt; db.guids.insert({&quot;name&quot;:&quot;replica set&quot;,&quot;author&quot;:&quot;webinglin&quot;})
WriteResult({ &quot;nInserted&quot; : 1 })
CoamReSet:PRIMARY&gt; exit
bye
</code></pre><blockquote>
<p>在 45.63.50.67 Secondary 节点中查询数据,验证是否能够正常的同步机器.</p>
</blockquote>
<pre><code>root@ubuntu:~# mongo --host 45.63.50.67
MongoDB shell version: 3.0.3
connecting to: 45.63.50.67:27017/test
Server has startup warnings:
2015-06-09T17:03:27.744-0700 I CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, which is not re                                      commended.
2015-06-09T17:03:27.744-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:27.745-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:27.745-0700 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is &apos;always&apos;.
2015-06-09T17:03:27.745-0700 I CONTROL  [initandlisten] **        We suggest setting it to &apos;never&apos;
2015-06-09T17:03:27.745-0700 I CONTROL  [initandlisten]
CoamReSet:SECONDARY&gt; show dbs
2015-06-09T17:13:49.138-0700 E QUERY    Error: listDatabases failed:{ &quot;note&quot; : &quot;from execCommand&quot;, &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not master&quot; }
    at Error (&lt;anonymous&gt;)
    at Mongo.getDBs (src/mongo/shell/mongo.js:47:15)
    at shellHelper.show (src/mongo/shell/utils.js:630:33)
    at shellHelper (src/mongo/shell/utils.js:524:36)
    at (shellhelp2):1:1 at src/mongo/shell/mongo.js:47
CoamReSet:SECONDARY&gt; use test
switched to db test
CoamReSet:SECONDARY&gt; db.guids.find()
Error: error: { &quot;$err&quot; : &quot;not master and slaveOk=false&quot;, &quot;code&quot; : 13435 }
CoamReSet:SECONDARY&gt; rs.slaveOk()
CoamReSet:SECONDARY&gt; rs.slaveOk()
CoamReSet:SECONDARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;557780ebd147e9391020860d&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:SECONDARY&gt; show collections()
2015-06-09T17:14:24.219-0700 E QUERY    Error: don&apos;t know how to show [collections()]
    at Error (&lt;anonymous&gt;)
    at shellHelper.show (src/mongo/shell/utils.js:733:11)
    at shellHelper (src/mongo/shell/utils.js:524:36)
    at (shellhelp2):1:1 at src/mongo/shell/utils.js:733
CoamReSet:SECONDARY&gt; show collections
guids
system.indexes
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><blockquote>
<p>在 42.96.194.60 Secondary 节点中查询数据,验证是否能够正常的同步机器.</p>
</blockquote>
<pre><code>root@ubuntu:~# mongo --host 42.96.194.60
MongoDB shell version: 3.0.3
connecting to: 42.96.194.60:27017/test
Server has startup warnings:
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, which is not re                                      commended.
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is &apos;always&apos;.
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten] **        We suggest setting it to &apos;never&apos;
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten]
CoamReSet:SECONDARY&gt; rs.slaveOk()
CoamReSet:SECONDARY&gt; show dbs
local  1.078GB
test   0.078GB
CoamReSet:SECONDARY&gt; use test
switched to db test
CoamReSet:SECONDARY&gt; show collections
guids
system.indexes
CoamReSet:SECONDARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;557780ebd147e9391020860d&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><p>至此,整个验证过程说明了我们集群部署是成功的.数据能够正常同步了.<br>那么接下来我们还要验证另一种情况,Primary异常终止之后（43.241.222.110）,另外两个Secondary节点会不会自动选举出新的Primary节点呢？<br>这个实验我们这样处理: 将 43.241.222.110 机器的mongod服务停止掉,然后再来连接 42.96.194.60 或者 45.63.50.67 任意一台机器,通过 rs.status() 查看集群状态.</p>
<blockquote>
<p>在Primary节点（43.241.222.110）通过 ps -e | grep mongod 查看mongod服务是否开启,然后通过 killall mongod 或者 kill -15 &lt;进程号&gt; 来杀死mongod进程</p>
</blockquote>
<pre><code>root@ubuntu:~# ps -e | grep mongod
 3279 pts/0    00:00:19 mongod
root@ubuntu:~# killall mongod
</code></pre><blockquote>
<p>登陆从节点 42.96.194.60 ,查看mongo服务器状态</p>
</blockquote>
<pre><code>root@ubuntu:~# mongo --host 42.96.194.60
MongoDB shell version: 3.0.3
connecting to: 42.96.194.60:27017/test
Server has startup warnings:
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, which is not recommended.
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:11.647-0700 I CONTROL  [initandlisten]
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is &apos;always&apos;.
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten] **        We suggest setting it to &apos;never&apos;
2015-06-09T17:03:11.648-0700 I CONTROL  [initandlisten]
CoamReSet:SECONDARY&gt; rs.status()
{
    &quot;set&quot; : &quot;CoamReSet&quot;,
    &quot;date&quot; : ISODate(&quot;2015-10-01T10:09:57.981Z&quot;),
    &quot;myState&quot; : 1,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 0,
            &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
            &quot;health&quot; : 0,
            &quot;state&quot; : 8,
            &quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,
            &quot;uptime&quot; : 0,
            &quot;optime&quot; : Timestamp(0, 0),
            &quot;optimeDate&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:09:56.226Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:07:54.850Z&quot;),
            &quot;pingMs&quot; : 18,
            &quot;lastHeartbeatMessage&quot; : &quot;Failed attempt to connect to 43.241.222.110:27017; couldn&apos;t connect to server 43.241.222.110:27017 (43.241.222.110), connection attempt failed&quot;,            &quot;configVersion&quot; : -1
        },
        {
            &quot;_id&quot; : 1,
            &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 1,
            &quot;stateStr&quot; : &quot;PRIMARY&quot;,
            &quot;uptime&quot; : 1577,
            &quot;optime&quot; : Timestamp(1443693679, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:01:19Z&quot;),
            &quot;electionTime&quot; : Timestamp(1443694079, 1),
            &quot;electionDate&quot; : ISODate(&quot;2015-10-01T10:07:59Z&quot;),
            &quot;configVersion&quot; : 1,
            &quot;self&quot; : true
        },
        {
            &quot;_id&quot; : 2,
            &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 1481,
            &quot;optime&quot; : Timestamp(1443693679, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:01:19Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:09:56.891Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:09:57.259Z&quot;),
            &quot;pingMs&quot; : 440,
            &quot;configVersion&quot; : 1
        }
    ],
    &quot;ok&quot; : 1
}
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><p>通过上面这段代码的观察,我们发现,当把原来的Primary节点停止掉后（43.241.222.110停止）, 那么整个mongodb的副本集群会重新选举出新的Primary节点（ 42.96.194.60 机器）</p>
<p>为了验证一下新选举的Primary是否正常,我们再次验证一把数据的同步情况,先连接到 42.96.194.60 主节点,将原来的数据删掉,再到 45.63.50.67 SECONDARY 进行验证,数据是否也被删除</p>
<blockquote>
<p>连接到 42.96.194.60 主节点,将原来的数据删掉</p>
</blockquote>
<pre><code>root@ubuntu:~# mongo --host 42.96.194.60
CoamReSet:PRIMARY&gt; use test
switched to db test
CoamReSet:PRIMARY&gt; show collections
guids
CoamReSet:PRIMARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
{ &quot;_id&quot; : ObjectId(&quot;560d046f9548a3e5bb8b03c0&quot;), &quot;name&quot; : &quot;zhang&quot;, &quot;author&quot; : &quot;yafei...&quot; }
CoamReSet:PRIMARY&gt; db.guids.remove({name:&quot;zhang&quot;})
WriteResult({ &quot;nRemoved&quot; : 1 })
CoamReSet:PRIMARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:PRIMARY&gt; exit
bye
</code></pre><blockquote>
<p>再到 45.63.50.67 SECONDARY 进行验证,数据是否也被删除</p>
</blockquote>
<pre><code>root@ubuntu:~# mongo --host 45.63.50.67
CoamReSet:SECONDARY&gt; rs.slaveOk()
CoamReSet:SECONDARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;557780ebd147e9391020860d&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><p>实践后发现,先选举的Primary节点也正常工作.我们的整个Mongodb副本集群测试完成.</p>
<h3 id="动态添加节点-删除节点"><a href="#动态添加节点-删除节点" class="headerlink" title="动态添加节点,删除节点."></a>动态添加节点,删除节点.</h3><p>在开始这个实验之前,先把 43.241.222.110 的机器重新启动,然后用mongo客户端连到 43.241.222.110 进行验证数据是否也同步了.<br>登录 43.241.222.110 之后,我们发现数据也同步了,然后43.241.222.110节点变成了 Secondary 节点了.</p>
<pre><code>root@ubuntu:~# mongo
CoamReSet:SECONDARY&gt; rs.slaveOk()
CoamReSet:SECONDARY&gt; show dbs
local   0.000GB
syData  0.000GB
test    0.000GB
CoamReSet:SECONDARY&gt; use test
switched to db test
CoamReSet:SECONDARY&gt; show collections
guids
CoamReSet:SECONDARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:SECONDARY&gt; rs.status()
{
    &quot;set&quot; : &quot;CoamReSet&quot;,
    &quot;date&quot; : ISODate(&quot;2015-10-01T10:21:53.366Z&quot;),
    &quot;myState&quot; : 2,
    &quot;syncingTo&quot; : &quot;42.96.194.60:27017&quot;,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 0,
            &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 68,
            &quot;optime&quot; : Timestamp(1443694583, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:16:23Z&quot;),
            &quot;syncingTo&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;configVersion&quot; : 1,
            &quot;self&quot; : true
        },
        {
            &quot;_id&quot; : 1,
            &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 1,
            &quot;stateStr&quot; : &quot;PRIMARY&quot;,
            &quot;uptime&quot; : 66,
            &quot;optime&quot; : Timestamp(1443694583, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:16:23Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:21:53.026Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:21:52.588Z&quot;),
            &quot;pingMs&quot; : 16,
            &quot;electionTime&quot; : Timestamp(1443694079, 1),
            &quot;electionDate&quot; : ISODate(&quot;2015-10-01T10:07:59Z&quot;),
            &quot;configVersion&quot; : 1
        },
        {
            &quot;_id&quot; : 2,
            &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 66,
            &quot;optime&quot; : Timestamp(1443694583, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:16:23Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:21:51.818Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:21:53.006Z&quot;),
            &quot;pingMs&quot; : 311,
            &quot;syncingTo&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;configVersion&quot; : 1
        }
    ],
    &quot;ok&quot; : 1
}
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><p>登录到 42.96.194.60 Primary 节点,通过 rs.remove() 方法来删除副本集中的某一个节点,这里我们还是将 43.241.222.110 删除.删除之后我们还往 42.96.194.60 主节点中加入数据.</p>
<pre><code>CoamReSet:PRIMARY&gt; rs.remove(&quot;43.241.222.110:27017&quot;)
{ &quot;ok&quot; : 1 }
CoamReSet:PRIMARY&gt; rs.status()
{
    &quot;set&quot; : &quot;CoamReSet&quot;,
    &quot;date&quot; : ISODate(&quot;2015-10-01T10:24:35.061Z&quot;),
    &quot;myState&quot; : 1,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 1,
            &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 1,
            &quot;stateStr&quot; : &quot;PRIMARY&quot;,
            &quot;uptime&quot; : 2455,
            &quot;optime&quot; : Timestamp(1443695065, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:24:25Z&quot;),
            &quot;electionTime&quot; : Timestamp(1443694079, 1),
            &quot;electionDate&quot; : ISODate(&quot;2015-10-01T10:07:59Z&quot;),
            &quot;configVersion&quot; : 2,
            &quot;self&quot; : true
        },
        {
            &quot;_id&quot; : 2,
            &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 2358,
            &quot;optime&quot; : Timestamp(1443695065, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:24:25Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:24:33.256Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:24:34.102Z&quot;),
            &quot;pingMs&quot; : 334,
            &quot;configVersion&quot; : 2
        }
    ],
    &quot;ok&quot; : 1
}
CoamReSet:PRIMARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
CoamReSet:PRIMARY&gt; db.guids.insert({&quot;name&quot;:&quot;remove one node dync&quot;})
WriteResult({ &quot;nInserted&quot; : 1 })
CoamReSet:PRIMARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
{ &quot;_id&quot; : ObjectId(&quot;560d0a1d7d9deef6a0890b1f&quot;), &quot;name&quot; : &quot;remove one node dync&quot; }
CoamReSet:PRIMARY&gt; exit
bye
</code></pre><p>删除 43.241.222.110 节点后,我们往 Primary 节点中加入了新的数据,然后先不要将 43.241.222.110 的 mongod 服务停掉,我们通过mongo连接到 43.241.222.110 的mongod服务来查看数据</p>
<pre><code>root@ubuntu:~# mongo --host 43.241.222.110
&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
&gt; exit
bye
</code></pre><p>实验结果可以知道,我们在 45.63.50.67 新加入的数据 {name:”remove one node dync”} 并没有同步到43.241.222.110（已从副本集中删除）.</p>
<p>为了让实验结果更加确切,我们查看 43.241.222.110 是否有同步了数据:</p>
<p>root@ubuntu:~# mongo –host 45.63.50.67<br>CoamReSet:SECONDARY&gt; db.guids.find()<br>{ “_id” : ObjectId(“557780ebd147e9391020860d”), “name” : “replica set”, “author” : “webinglin” }<br>{ “_id” : ObjectId(“557785bcbb56172c8e069341”), “name” : “remove one node dync” }<br>CoamReSet:SECONDARY&gt; exit<br>bye</p>
<p>实验数据可以看到, 45.63.50.67 同步了在 42.96.194.60 主节点中新增的文档 {“name”:”remove one node dync”},这样就证明了动态删除副本集中的某一个节点的实验成功了.那怎么动态添加节点到副本集中呢？</p>
<p>原理是一样的,但是调用的方法变成了 rs.add(“43.241.222.110:27017”)</p>
<pre><code>CoamReSet:PRIMARY&gt; rs.add(&quot;43.241.222.110:27017&quot;);
{ &quot;ok&quot; : 1 }
CoamReSet:PRIMARY&gt; rs.status()
{
    &quot;set&quot; : &quot;CoamReSet&quot;,
    &quot;date&quot; : ISODate(&quot;2015-10-01T10:32:45.284Z&quot;),
    &quot;myState&quot; : 1,
    &quot;members&quot; : [
        {
            &quot;_id&quot; : 1,
            &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 1,
            &quot;stateStr&quot; : &quot;PRIMARY&quot;,
            &quot;uptime&quot; : 2945,
            &quot;optime&quot; : Timestamp(1443695560, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:32:40Z&quot;),
            &quot;electionTime&quot; : Timestamp(1443694079, 1),
            &quot;electionDate&quot; : ISODate(&quot;2015-10-01T10:07:59Z&quot;),
            &quot;configVersion&quot; : 3,
            &quot;self&quot; : true
        },
        {
            &quot;_id&quot; : 2,
            &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 2849,
            &quot;optime&quot; : Timestamp(1443695560, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:32:40Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:32:43.660Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:32:44.079Z&quot;),
            &quot;pingMs&quot; : 452,
            &quot;syncingTo&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;configVersion&quot; : 2
        },
        {
            &quot;_id&quot; : 3,
            &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
            &quot;health&quot; : 1,
            &quot;state&quot; : 2,
            &quot;stateStr&quot; : &quot;SECONDARY&quot;,
            &quot;uptime&quot; : 2,
            &quot;optime&quot; : Timestamp(1443695560, 1),
            &quot;optimeDate&quot; : ISODate(&quot;2015-10-01T10:32:40Z&quot;),
            &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-01T10:32:44.739Z&quot;),
            &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-01T10:32:43.300Z&quot;),
            &quot;pingMs&quot; : 16,
            &quot;syncingTo&quot; : &quot;42.96.194.60:27017&quot;,
            &quot;configVersion&quot; : 3
        }
    ],
    &quot;ok&quot; : 1
}
CoamReSet:PRIMARY&gt; exit
bye
</code></pre><p>在rs.status()返回的结果中可以看到,43.241.222.110 节点已经成功加入副本集中了.加入之后,理论上应该会把在 43.241.222.110 主节点加入的数据同步过来,刚才删除之后是不会同步的.那这时候重新加入副本集,应该是要同步的.下面是实验结果:</p>
<pre><code>root@ubuntu:~# mongo
CoamReSet:SECONDARY&gt; db.guids.find()
{ &quot;_id&quot; : ObjectId(&quot;560d03099548a3e5bb8b03bf&quot;), &quot;name&quot; : &quot;replica set&quot;, &quot;author&quot; : &quot;webinglin&quot; }
{ &quot;_id&quot; : ObjectId(&quot;560d0a1d7d9deef6a0890b1f&quot;), &quot;name&quot; : &quot;remove one node dync&quot; }
CoamReSet:SECONDARY&gt; exit
bye
</code></pre><p>实验结果显示,动态添加操作也正常.动态的将 43.241.222.110 节点加入到副本集中能够保证数据同步成功.</p>
<hr>
<p>注意</p>
<p>在调用 rs.add(“host:ip”) 或者 rs.remove(“host:ip”) 的时候,必须要在 Primary 节点中进行.</p>
<p>add方法可以加入一个document对象,这样就可以在指定具体的Secondary节点的更多的设置项了,比如指定为priority: 0 或 priority: 0,hidden: true 或 priority:0,hidden:true,arbiterOnly:true</p>
<pre><code>{
  _id: &lt;int&gt;,
  host: &lt;string&gt;,
  arbiterOnly: &lt;boolean&gt;,
  buildIndexes: &lt;boolean&gt;,
  hidden: &lt;boolean&gt;,
  priority: &lt;number&gt;,
  tags: &lt;document&gt;,
  slaveDelay: &lt;int&gt;,
  votes: &lt;number&gt;
}
</code></pre><p>怎么对副本集进行权限验证,参考主从复制的安全部分,也是通过openssl来生成keyfile,然后再启动mongod的时候指定keyFile来设置安全的</p>
<hr>
<blockquote>
<p>也可以在三个主机的复制集添加以下配置</p>
</blockquote>
<pre><code>replication:
##oplog大小
 oplogSizeMB: 20
##复制集名称
 replSetName: CoamReSet
</code></pre><hr>
<h3 id="复制集优先级问题"><a href="#复制集优先级问题" class="headerlink" title="复制集优先级问题"></a>复制集优先级问题</h3><blockquote>
<p>默认设定节点 43.241.222.110 为Primary主节点,由于初始配置中没有设定,于是在主节点服务器重启后 43.241.222.110 自动切换成 从节点,而 42.96.194.60 切换成了主节点导致应用程序连接错误<br>于是在当前主节点 43.241.222.110 通过命令行手动切换主节点到 43.241.222.110</p>
</blockquote>
<pre><code>CoamReSet:PRIMARY&gt; rs.status()
{
        &quot;set&quot; : &quot;CoamReSet&quot;,
        &quot;date&quot; : ISODate(&quot;2015-10-09T11:28:28.585Z&quot;),
        &quot;myState&quot; : 1,
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 1,
                        &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 1,
                        &quot;stateStr&quot; : &quot;PRIMARY&quot;,
                        &quot;uptime&quot; : 614570,
                        &quot;optime&quot; : Timestamp(1444378212, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2015-10-09T08:10:12Z&quot;),
                        &quot;electionTime&quot; : Timestamp(1444378334, 1),
                        &quot;electionDate&quot; : ISODate(&quot;2015-10-09T08:12:14Z&quot;),
                        &quot;configVersion&quot; : 3,
                        &quot;self&quot; : true
                },
                {
                        &quot;_id&quot; : 2,
                        &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
                        &quot;health&quot; : 0,
                        &quot;state&quot; : 8,
                        &quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,
                        &quot;uptime&quot; : 0,
                        &quot;optime&quot; : Timestamp(0, 0),
                        &quot;optimeDate&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),
                        &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-09T11:28:27.754Z&quot;),
                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-06T08:52:51.239Z&quot;),
                        &quot;pingMs&quot; : 406,
                        &quot;lastHeartbeatMessage&quot; : &quot;Failed attempt to connect to 45.63.50.67:27017; couldn&apos;t connect to server 45.63.50.67:27017 (45.63.50.67), connection attempt failed&quot;,
                        &quot;configVersion&quot; : -1
                },
                {
                        &quot;_id&quot; : 3,
                        &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 2,
                        &quot;stateStr&quot; : &quot;SECONDARY&quot;,
                        &quot;uptime&quot; : 90994,
                        &quot;optime&quot; : Timestamp(1444378212, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2015-10-09T08:10:12Z&quot;),
                        &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-09T11:28:27.532Z&quot;),
                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-09T11:28:27.299Z&quot;),
                        &quot;pingMs&quot; : 15,
                        &quot;configVersion&quot; : 3
                }
        ],
        &quot;ok&quot; : 1
}

CoamReSet:PRIMARY&gt; config = rs.conf()
{
        &quot;_id&quot; : &quot;CoamReSet&quot;,
        &quot;version&quot; : 3,
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 1,
                        &quot;host&quot; : &quot;42.96.194.60:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : 0,
                        &quot;votes&quot; : 1
                },
                {
                        &quot;_id&quot; : 2,
                        &quot;host&quot; : &quot;45.63.50.67:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : 0,
                        &quot;votes&quot; : 1
                },
                {
                        &quot;_id&quot; : 3,
                        &quot;host&quot; : &quot;43.241.222.110:27017&quot;,
                        &quot;arbiterOnly&quot; : false,
                        &quot;buildIndexes&quot; : true,
                        &quot;hidden&quot; : false,
                        &quot;priority&quot; : 1,
                        &quot;tags&quot; : {

                        },
                        &quot;slaveDelay&quot; : 0,
                        &quot;votes&quot; : 1
                }
        ],
        &quot;settings&quot; : {
                &quot;chainingAllowed&quot; : true,
                &quot;heartbeatTimeoutSecs&quot; : 10,
                &quot;getLastErrorModes&quot; : {

                },
                &quot;getLastErrorDefaults&quot; : {
                        &quot;w&quot; : 1,
                        &quot;wtimeout&quot; : 0
                }
        }
}
</code></pre><blockquote>
<p>设置第一个节点 42.96.194.60 优先级为1,第二个节点 45.63.50.67 优先级为0,第三个节点 43.241.222.110 优先级为2;</p>
</blockquote>
<pre><code>CoamReSet:PRIMARY&gt; config.members[0].priority = 1
1
CoamReSet:PRIMARY&gt; config.members[1].priority = 0
0
CoamReSet:PRIMARY&gt; config.members[2].priority = 2
2
CoamReSet:PRIMARY&gt; rs.reconfig(config)
{ &quot;ok&quot; : 1 }
CoamReSet:PRIMARY&gt; rs.status()
{
        &quot;set&quot; : &quot;CoamReSet&quot;,
        &quot;date&quot; : ISODate(&quot;2015-10-09T12:03:37.679Z&quot;),
        &quot;myState&quot; : 2,
        &quot;syncingTo&quot; : &quot;43.241.222.110:27017&quot;,
        &quot;members&quot; : [
                {
                        &quot;_id&quot; : 1,
                        &quot;name&quot; : &quot;42.96.194.60:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 2,
                        &quot;stateStr&quot; : &quot;SECONDARY&quot;,
                        &quot;uptime&quot; : 616679,
                        &quot;optime&quot; : Timestamp(1444392119, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2015-10-09T12:01:59Z&quot;),
                        &quot;syncingTo&quot; : &quot;43.241.222.110:27017&quot;,
                        &quot;configVersion&quot; : 5,
                        &quot;self&quot; : true
                },
                {
                        &quot;_id&quot; : 2,
                        &quot;name&quot; : &quot;45.63.50.67:27017&quot;,
                        &quot;health&quot; : 0,
                        &quot;state&quot; : 8,
                        &quot;stateStr&quot; : &quot;(not reachable/healthy)&quot;,
                        &quot;uptime&quot; : 0,
                        &quot;optime&quot; : Timestamp(0, 0),
                        &quot;optimeDate&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;),
                        &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-09T12:03:35.875Z&quot;),
                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-06T08:52:51.239Z&quot;),
                        &quot;pingMs&quot; : 406,
                        &quot;lastHeartbeatMessage&quot; : &quot;Failed attempt to connect to 45.63.50.67:27017; couldn&apos;t connect to server 45.63.50.67:27017 (45.63.50.67), connection attempt failed&quot;,
                        &quot;configVersion&quot; : -1
                },
                {
                        &quot;_id&quot; : 3,
                        &quot;name&quot; : &quot;43.241.222.110:27017&quot;,
                        &quot;health&quot; : 1,
                        &quot;state&quot; : 1,
                        &quot;stateStr&quot; : &quot;PRIMARY&quot;,
                        &quot;uptime&quot; : 93103,
                        &quot;optime&quot; : Timestamp(1444392119, 1),
                        &quot;optimeDate&quot; : ISODate(&quot;2015-10-09T12:01:59Z&quot;),
                        &quot;lastHeartbeat&quot; : ISODate(&quot;2015-10-09T12:03:35.817Z&quot;),
                        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2015-10-09T12:03:36.764Z&quot;),
                        &quot;pingMs&quot; : 17,
                        &quot;electionTime&quot; : Timestamp(1444390463, 1),
                        &quot;electionDate&quot; : ISODate(&quot;2015-10-09T11:34:23Z&quot;),
                        &quot;configVersion&quot; : 5
                }
        ],
        &quot;ok&quot; : 1
}
</code></pre><p>可以看到 43.241.222.110 已经成功切换成主节点了<br>关闭主节点 43.241.222.110 后,发现两个从节点没有自动切换成主节点,相当于关闭了 MongoDB 复制集功能<br><a href="http://debugo.com/mongo-rs-prio/" target="_blank" rel="external">MongoDB RS优先级设置</a><br><a href="http://docs.mongodb.org/manual/tutorial/force-member-to-be-primary/" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/force-member-to-be-primary/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-MongoDB/MongoNotes" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/MongoDB/MongoNotes/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/MongoDB/MongoNotes/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h4 id="MongoDB-管理笔记摘要"><a href="#MongoDB-管理笔记摘要" class="headerlink" title="MongoDB 管理笔记摘要"></a>MongoDB 管理笔记摘要</h4><blockquote>
<p>MongoDB 修改重命名字段名</p>
</blockquote>
<h5 id="通过命令行批量修改"><a href="#通过命令行批量修改" class="headerlink" title="通过命令行批量修改"></a>通过命令行批量修改</h5><blockquote>
<p>修改一级字段名</p>
</blockquote>
<pre><code>CoamReSet:PRIMARY&gt; db.TruckRoadsPath.update({},{$rename:{&quot;Lng&quot;:&quot;lng&quot;}},{multi:true})
WriteResult({ &quot;nMatched&quot; : 2702582, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 2702582 })
</code></pre><blockquote>
<p>修改二级字段名</p>
</blockquote>
<p>CoamReSet:PRIMARY&gt; db.TruckRoadsPath.update({},{$rename:{“PathInfo.Speed”:”PathInfo.speed”}},{multi:true})</p>
<blockquote>
<p>出现以下错误,提示不能更新 PathInfo 为 null 的数据,提示更新失败,但检查数据发现已全部正确更新过来了</p>
</blockquote>
<pre><code>WriteResult({
        &quot;nMatched&quot; : 0,
        &quot;nUpserted&quot; : 0,
        &quot;nModified&quot; : 0,
        &quot;writeError&quot; : {
                &quot;code&quot; : 16837,
                &quot;errmsg&quot; : &quot;cannot use the part (PathInfo of PathInfo.Speed) to traverse the element ({PathInfo: null})&quot;
        }
})
</code></pre><blockquote>
<p>正确的检查非 null 条件下的写法应该是:</p>
</blockquote>
<pre><code>CoamReSet:PRIMARY&gt; db.TruckRoadsPath.update({&quot;PathInfo&quot;:{$ne:null}},{$rename:{&quot;PathInfo.State&quot;:&quot;PathInfo.state&quot;}},{multi:true})
WriteResult({ &quot;nMatched&quot; : 2702158, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 2702156 })
</code></pre><p>参考 <a href="http://stackoverflow.com/questions/4057196/how-do-you-query-this-in-mongo-is-not-null" target="_blank" rel="external">How do you query this in Mongo? (is not null)</a></p>
<hr>
<p>参考<br><a href="http://nosqldb.org/p/50d1cbacbcc7e7cc590007d2" target="_blank" rel="external">如何在MongoDB 修改字段名称,重命名字段</a><br><a href="https://docs.mongodb.org/manual/reference/operator/update/rename/" target="_blank" rel="external">Mongo docs - $rename</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-GPS/GPSNote" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/GPS/GPSNote/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/GPS/GPSNote/">Title</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="GPS相关"><a href="#GPS相关" class="headerlink" title="GPS相关"></a>GPS相关</h2><p><a href="http://yanue.net/post-122.html" target="_blank" rel="external">gps纠偏数据库及gps纠偏算法PHP</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-Erlang/Rebar" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/Erlang/Rebar/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/Erlang/Rebar/">RebarNote</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="使用-Rebar-管理-erlang-项目"><a href="#使用-Rebar-管理-erlang-项目" class="headerlink" title="使用 Rebar 管理 erlang 项目"></a>使用 Rebar 管理 erlang 项目</h3><p><a href="https://github.com/rebar/rebar" target="_blank" rel="external">GitHub - </a></p>
<h4 id="使用-Intellij-idea15-利用-rebar-开发调试-ejabberd"><a href="#使用-Intellij-idea15-利用-rebar-开发调试-ejabberd" class="headerlink" title="使用 Intellij idea15 利用 rebar 开发调试 ejabberd"></a>使用 Intellij idea15 利用 rebar 开发调试 ejabberd</h4><blockquote>
<p>默认 Erlang 的 ejabberd 根项目下已经有 rebar 文件了</p>
</blockquote>
<p>1.Win下安装 <a href="http://www.erlang.org/download/otp_win64_18.2.1.exe" target="_blank" rel="external">otp.18</a> 到 G:\Program Files\erl7.2.1 下<br>2.将 G:\Program Files\erl7.2.1 添加系统环境变量 PATH<br>3.Intellij idea 项目 ejabberd 中 SDK 添加 OTP18.**<br>4.win下使用 Cygwin 安装 rebar</p>
<pre><code>$ git clone git://github.com/rebar/rebar.git
$ cd rebar
$ ./bootstrap
Recompile: src/getopt
...
Recompile: src/rebar_utils
==&gt; rebar (compile)
Congratulations! You now have a self-contained script called &quot;rebar&quot; in
your current working directory. Place this script anywhere in your path
and you can use rebar to build OTP-compliant apps.
</code></pre><p>它将自动将 rebar 安装到 C:\Users\yafei\rebar 下</p>
<ol>
<li><p>File-&gt;Other Setting-&gt;Default Setting-&gt;Erlang Extenal Tools 配置 PATH 为 C:\Users\yafei\rebar\rebar.cmd</p>
</li>
<li><p>File-&gt;Setting-&gt;Setting-&gt;In “Build, Execution, Deployment/Erlan Compiler”, 勾选 “Compile project with rebar”.</p>
</li>
</ol>
<p>6.Menu -&gt; Run -&gt; Edit Configurations -&gt; 添加按钮 -&gt; Erlang Rebar ,具体配置为 在 Command 一栏添加 任务 delete-deps clean get-deps compile 并任意填写一个任务名称 coamerlangtask</p>
<p>7.在 Intellij idea 右上角可以点击运行开始打包</p>
<hr>
<h3 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h3><blockquote>
<p>rebar unable to get dependency from github</p>
<p>使用简单的 clean compile 命令会出现很多未找到依赖包 * ,因为编译 compile 前先要 get-deps 所以将 rebar 编译命令改为 delete-deps clean get-deps compile</p>
</blockquote>
<p>参考 <a href="http://stackoverflow.com/questions/10059579/rebar-unable-to-get-dependency-from-github" target="_blank" rel="external">rebar unable to get dependency from github</a></p>
<hr>
<p>参考列表<br><a href="https://github.com/rebar/rebar/wiki/Rebar-commands" target="_blank" rel="external">Rebar commands</a><br><a href="http://zewaren.net/site/?q=node/144" target="_blank" rel="external">Using Intellij IDEA to write and debug Erlang code</a><br><a href="https://www.jetbrains.com/idea/help/getting-started-with-erlang.html#d207953e377" target="_blank" rel="external">Intellij Idea 官网说明</a><br><a href="http://blog.csdn.net/shake1050/article/details/43670281" target="_blank" rel="external">windows下使用IntelliJ IDEA的erlang编译环境搭建(含rebar工具)</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-Erlang/Mnesia" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/Erlang/Mnesia/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/Erlang/Mnesia/">MnesiaNote</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Erlang-Mnesia-Database"><a href="#Erlang-Mnesia-Database" class="headerlink" title="Erlang Mnesia Database"></a>Erlang Mnesia Database</h3><p><a href="http://www.erlang.org/doc/man/mnesia.html" target="_blank" rel="external">Erlang Mnesia Doc</a></p>
<p>最近学习erlang,在erlang中天然集成了一个分布式数据库名字叫mnesia,因为数据库天然就和erlang的元组,记录无缝结合,并且具有良好的分布式特性,能够自动地在几个erlang节点上实现数据复制,效果有点像zookeeper的节点集群,<br>而且mnesia还支持数据库事务特性,所以mnesia在erlang应用中使用得非常频繁.</p>
<p>要在本地创建一个mnesia数据库,并且要实现插入,查询功能需要实现以下这几步:<br>1.启动erlang节点:</p>
<pre><code>#erl -mnesia dir &apos;&quot;d://tmp//mnesia&quot;&apos; -sname mynode
erl -mnesia dir &apos;&quot;C:\Users\yafei\DevWork\Erlang\dev\mnesia\data&quot;&apos; -name win@27.16.194.65 -setcookie 456789
sudo erl -mnesia dir &apos;&quot;/data/home/data/mnesia/&quot;&apos; -name ali@42.96.194.60 -setcookie 456789
</code></pre><p>注意路径双引号<br> 以上这个 “/data/home/data/mnesia/“ 目录是存放mnesia数据库的schema数据的,当然这个目录也可以不指定,那么mnesia数据库启动之后将把数据库的schema中的数据放在内存中,如果下次节点重启之后,之前数据库中创建的表结构数据就消失了.<br>2.接下来就是在erl shell中本地初始化一个空的 mnesia 数据库</p>
<pre><code>mnesia:create_schema([node()]).
</code></pre><p>  从参数上是一个节点列表,所以其实需要的话,可以在参数列表上设置多个erlang节点,就能在多个erlang节点上同时创建mnesia数据库并构成 Mnesia 集群.<br>3.启动mnesia数据库<br>  初始化完成了mnesia数据库schema之后,接下来就可以启动mneisa数据库了.</p>
<pre><code>mnesia:start().
</code></pre><p>至此,一个空的mneisa已经创建启动成功了,我们可以调用mnesia:info(). 查看当前mnesia数据库的一些状态,结果如下:</p>
<pre><code>(ali@localhost)2&gt; mnesia:info().
===&gt; System info in version &quot;4.13.2&quot;, debug level = none &lt;===
opt_disc. Directory &quot;/data/home/data/mnesia&quot; is used.
use fallback at restart = true
running db nodes   = []
stopped db nodes   = [ali@localhost]
ok
(ali@localhost)3&gt; mnesia:start().
ok
(ali@localhost)4&gt; mnesia:info().
---&gt; Processes holding locks &lt;---
---&gt; Processes waiting for locks &lt;---
---&gt; Participant transactions &lt;---
---&gt; Coordinator transactions &lt;---
---&gt; Uncertain transactions &lt;---
---&gt; Active tables &lt;---
schema         : with 1        records occupying 408      words of mem
===&gt; System info in version &quot;4.13.2&quot;, debug level = none &lt;===
opt_disc. Directory &quot;/data/home/data/mnesia&quot; is used.
use fallback at restart = false
running db nodes   = [ali@localhost]
stopped db nodes   = []
master node tables = []
remote             = []
ram_copies         = []
disc_copies        = [schema]
disc_only_copies   = []
[{ali@localhost,disc_copies}] = [schema]
2 transactions committed, 0 aborted, 0 restarted, 0 logged to disc
0 held locks, 0 in queue; 0 local transactions, 0 remote
0 transactions waits for other nodes: []
ok
</code></pre><p>从 [{ali@localhost,disc_copies}] = [schema] 这行上来看当前数据库中只有一个数据库的schema表.</p>
<hr>
<h4 id="Mnesia-集群"><a href="#Mnesia-集群" class="headerlink" title="Mnesia 集群"></a>Mnesia 集群</h4><p>分别在 阿里云 ali 和 本机 win 启动两个节点</p>
<pre><code>sudo -mnesia dir &apos;&quot;/data/home/data/mnesia/&quot;&apos; -name ali@42.96.194.60 -setcookie 456789
erl -mnesia dir &apos;&quot;C:\Users\yafei\DevWork\Erlang\dev\mnesia\data&quot;&apos; -name win@27.16.194.65 -setcookie 456789
</code></pre><p>保证两个节点都启动,并且 mnesia 没有启用</p>
<pre><code>mnesia:delete_schema([&apos;win@27.16.194.65&apos;, &apos;ali@42.96.194.60&apos;]).
mnesia:create_schema([&apos;win@27.16.194.65&apos;, &apos;ali@42.96.194.60&apos;]).
</code></pre><p>然后启动两个节点的 mnesia,查看运行详情</p>
<pre><code>(win@27.16.194.65)9&gt; mnesia:start().
(win@27.16.194.65)9&gt; mnesia:info().
---&gt; Processes holding locks &lt;---
---&gt; Processes waiting for locks &lt;---
---&gt; Participant transactions &lt;---
---&gt; Coordinator transactions &lt;---
---&gt; Uncertain transactions &lt;---
---&gt; Active tables &lt;---
schema         : with 1        records occupying 414      words of mem
===&gt; System info in version &quot;4.13.2&quot;, debug level = none &lt;===
opt_disc. Directory [99,58,47,85,115,101,114,115,47,121,97,102,101,105,47,68,
101,118,87,111,114,107,47,69,114,108,97,110,103,47,100,
101,118,47,109,110,101,115,105,97,47,85,115,101,114,115,
121,97,102,101,105,68,101,118,87,111,114,107,69,114,108,
97,110,103,127,101,118,109,110,101,115,105,97,127,97,116,
97] is used.
use fallback at restart = false
running db nodes   = [&apos;ali@42.96.194.60&apos;,&apos;win@27.16.194.65&apos;]
stopped db nodes   = []
master node tables = []
remote             = []
ram_copies         = []
disc_copies        = [schema]
disc_only_copies   = []
[{&apos;ali@42.96.194.60&apos;,disc_copies},{&apos;win@27.16.194.65&apos;,disc_copies}] = [schema]
3 transactions committed, 0 aborted, 1 restarted, 2 logged to disc
0 held locks, 0 in queue; 0 local transactions, 0 remote
0 transactions waits for other nodes: []
ok
</code></pre><p>根据 running db nodes   = [‘ali@42.96.194.60’,’win@27.16.194.65’] 可以看出两个节点已成功组成 节点</p>
<p>在任何一个节点添加数据表</p>
<hr>
<h4 id="erlang-mnesia-数据库实现SQL查询"><a href="#erlang-mnesia-数据库实现SQL查询" class="headerlink" title="erlang mnesia 数据库实现SQL查询"></a>erlang mnesia 数据库实现SQL查询</h4><blockquote>
<p>Mnesia是一个分布式数据库管理系统,适合于电信和其它需要持续运行和具备软实时特性的Erlang应用,越来越受关注和使用,但是目前Mnesia资料却不多,很多都只有官方的用户指南.<br>下面的内容将着重说明  Mnesia 数据库如何实现SQL查询,实现select / insert / update / where / order by / join / limit / delete等SQL操作.</p>
</blockquote>
<p>参见示例 sql.erl</p>
<blockquote>
<p>注:使用qlc模块查询,需要在文件顶部声明”-include_lib(“stdlib/include/qlc.hrl”).”,否则编译时会产生”Warning: qlc:q/1 called, but “qlc.hrl” not included”的警告.</p>
</blockquote>
<hr>
<h4 id="使用单独的脚本连接-ejabberd-mnesia-数据库"><a href="#使用单独的脚本连接-ejabberd-mnesia-数据库" class="headerlink" title="使用单独的脚本连接 ejabberd mnesia 数据库"></a>使用单独的脚本连接 ejabberd mnesia 数据库</h4><pre><code>Cookie = &apos;YOUR_EJABBERD_COOKIE&apos;. % mine was found in /var/lib/ejabberd/.erlang.cookie
EjabberdNode = &apos;ejabberd@127.0.0.1&apos;. % or whatever you set as EJABBERD_NODE
erlang:set_cookie(EjabberdNode, Cookie).
net_adm:ping(EjabberdNode).
rpc:call(EjabberdNode, mnesia, system_info, [tables]).
</code></pre><p>参考 <a href="http://stackoverflow.com/questions/9232510/how-can-i-connect-to-ejabberds-mnesia-database-with-a-separate-script" target="_blank" rel="external">How can I connect to ejabberd’s Mnesia database with a separate script?</a></p>
<hr>
<h4 id="mnesia表数据Id自增长"><a href="#mnesia表数据Id自增长" class="headerlink" title="mnesia表数据Id自增长"></a>mnesia表数据Id自增长</h4><p>1.使用函数:</p>
<pre><code>mnesia:dirty_update_counter(unique_id, mine_result, 1).
</code></pre><p>2.该函数参数示意,<br>   unique_id 表名, mine_result 表名,每次自增N.<br>3.<br>   1.创建如下结构的mnesia数据库表 -record(unique_id, {item, uid}),该表是为了存储 mine_result 表的最大的Id值;<br>   2.每为 mine_result 表加入一条新记录时,需要得到新的id值: </p>
<pre><code>mnesia:dirty_update_counter(unique_id,  mine_result , 1),
</code></pre><p>从unique_id表中取出最大的Id值加1,更新unique_id表的数据,返回最大Id值加1,<br>注意:请在建立unique_id表的时候,往里面插入数据;表名,初始值,{ mine_result  ,0},<br>我做了一个实验如果unique_id表中没有数据的时候,并发向mine_result库中插入100条数据时,不稳定.<br>但是unique_id表中加入一个数据后,并发数提高到30000,还是很稳定.</p>
<hr>
<p>参考<br><a href="http://wudaijun.com/2015/04/erlang-mnesia/" target="_blank" rel="external">wudaijun’s blog - Erlang mnesia</a><br><a href="http://www.tqcto.com/article/db/11625.html" target="_blank" rel="external">创设Mnesia数据库</a><br><a href="http://www.infoq.com/cn/news/2007/08/mnesia" target="_blank" rel="external">Erlang的Mnesia——为高伸缩性应用准备的数据库管理系统</a><br><a href="http://www.cnblogs.com/liangjingyang/archive/2012/09/27/2705451.html" target="_blank" rel="external">[Erlang-0008][OTP] 高效指南 – 表和数据库(ets mnesia)</a><br><a href="http://www.dlive.me/2014/12/10/erlangmnesia/" target="_blank" rel="external">Erlang基础Mnesia 之应用场景</a><br><a href="http://blog.maxkit.com.tw/2014/04/erlang-mnesia.html" target="_blank" rel="external">erlang Mnesia - 尚待研究</a></p>
<p><a href="http://4096.info/2013/10/28/mnesia%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" target="_blank" rel="external">mnesia数据库使用体验</a><br><a href="http://4096.info/2014/11/07/no-title-2/" target="_blank" rel="external">mnesia数据库优化</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-Erlang/MQTT" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/Erlang/MQTT/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/Erlang/MQTT/">MQTTNote</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="关于-MQTT-协议"><a href="#关于-MQTT-协议" class="headerlink" title="关于 MQTT 协议"></a>关于 MQTT 协议</h3><p><a href="https://github.com/liangjingyang/MQTT-CN/blob/master/mqtt-v3.1.1-os.md" target="_blank" rel="external">MQTT 中文文档 Version 3.1.1</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
    <article id="post-Erlang/Lua" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/10/Erlang/Lua/" class="article-date">
      <time datetime="2016-01-10T11:41:31.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/10/Erlang/Lua/">LuaNote</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Lua-学习摘要"><a href="#Lua-学习摘要" class="headerlink" title="Lua 学习摘要"></a>Lua 学习摘要</h3><p><a href="http://dhq.me/lua-learning-notes-package-and-module" target="_blank" rel="external">Lua 学习笔记(4) – 模块与包</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>








  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 张亚飞
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        <div class="visit">
            <span id="busuanzi_container_site_pv" style='display:none'>
                <span id="site-visit" >本站到访数: 
                    <span id="busuanzi_value_site_uv"></span>
                </span>
            </span>
            <span id="busuanzi_container_page_pv" style='display:none'>
                <span id="page-visit">, 本页阅读量: 
                    <span id="busuanzi_value_page_pv"></span>
                </span>
            </span>
        </div>
    </div>
</footer>
    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>