<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>MysqlSyncNote | 商运物流</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Mysql双机热备份Mysql 主从同步配置概述 首先主服务器把数据变化记录到主日志,然后从服务器通过I/O线程读取主服务器上的主日志,并且把它写入到从服务器的中继日志中,接着SQL线程读取中继日志,并且在从服务器上重放,从而实现MySQL复制.具体如下图所示:
replication
整个过程反映到从服务器上,对应三套日志信息,可在从服务器上用如下命令查看:
1mysql&amp;gt; SHOW SL">
<meta property="og:type" content="article">
<meta property="og:title" content="MysqlSyncNote">
<meta property="og:url" content="https://coam.co/2016/05/14/Mysql/MysqlSyncNote/index.html">
<meta property="og:site_name" content="商运物流">
<meta property="og:description" content="Mysql双机热备份Mysql 主从同步配置概述 首先主服务器把数据变化记录到主日志,然后从服务器通过I/O线程读取主服务器上的主日志,并且把它写入到从服务器的中继日志中,接着SQL线程读取中继日志,并且在从服务器上重放,从而实现MySQL复制.具体如下图所示:
replication
整个过程反映到从服务器上,对应三套日志信息,可在从服务器上用如下命令查看:
1mysql&amp;gt; SHOW SL">
<meta property="og:updated_time" content="2016-05-19T08:26:49.403Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MysqlSyncNote">
<meta name="twitter:description" content="Mysql双机热备份Mysql 主从同步配置概述 首先主服务器把数据变化记录到主日志,然后从服务器通过I/O线程读取主服务器上的主日志,并且把它写入到从服务器的中继日志中,接着SQL线程读取中继日志,并且在从服务器上重放,从而实现MySQL复制.具体如下图所示:
replication
整个过程反映到从服务器上,对应三套日志信息,可在从服务器上用如下命令查看:
1mysql&amp;gt; SHOW SL">
  
    <link rel="alternative" href="/atom.xml" title="商运物流" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/author.jpg" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/">张亚飞</a></h1>
        </hgroup>

        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:zyf@lonal.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/zyfmix" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/markdown-gfw-hexo-jekyll/" style="font-size: 10px;">markdown gfw hexo jekyll</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://coam.co">商运物流</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/zyfmix/">GitHub</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://wp.iirii.com/">商运技术博客</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于物流设计</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">张亚飞</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img lazy-src="/img/author.jpg" class="js-avatar">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">张亚飞</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:zyf@lonal.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/zyfmix" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-Mysql/MysqlSyncNote" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/14/Mysql/MysqlSyncNote/" class="article-date">
      <time datetime="2016-05-14T09:03:31.000Z" itemprop="datePublished">2016-05-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      MysqlSyncNote
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Mysql双机热备份"><a href="#Mysql双机热备份" class="headerlink" title="Mysql双机热备份"></a>Mysql双机热备份</h3><h4 id="Mysql-主从同步配置"><a href="#Mysql-主从同步配置" class="headerlink" title="Mysql 主从同步配置"></a>Mysql 主从同步配置</h4><p>概述 首先主服务器把数据变化记录到主日志,然后从服务器通过I/O线程读取主服务器上的主日志,并且把它写入到从服务器的中继日志中,接着SQL线程读取中继日志,并且在从服务器上重放,从而实现MySQL复制.具体如下图所示:</p>
<p>replication</p>
<p>整个过程反映到从服务器上,对应三套日志信息,可在从服务器上用如下命令查看:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW SLAVE STATUS;</span><br></pre></td></tr></table></figure>
<pre><code>Master_Log_File &amp; Read_Master_Log_Pos:下一个传输的主日志信息.
Relay_Master_Log_File &amp; Exec_Master_Log_Pos:下一个执行的主日志信息.
Relay_Log_File &amp; Relay_Log_Pos:下一个执行的中继日志信息.
</code></pre><p>理解这些日志信息的含义对于解决故障至关重要</p>
<p>两台服务器搭建Mysql双机热备份 mysql 版本最好一致</p>
<hr>
<h4 id="一-A主B从"><a href="#一-A主B从" class="headerlink" title="一. A主B从"></a>一. A主B从</h4><ul>
<li>主服务器 A: 43.241.222.110</li>
<li>从服务器 B: 42.96.194.60</li>
</ul>
<p>在主A服务器(master)下创建给从B服务器 (slave)登录用的用户名密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">'syBackup'</span>@<span class="string">'42.96.194.60'</span> IDENTIFIED BY <span class="string">'******'</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>设置主服务器 A 需要复制的数据库<br>打开主服务器 A 的Mysql配置文件 <em>/etc/mysql/my.cnf</em></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################################</span></span><br><span class="line">server-id=<span class="number">1</span> <span class="comment">#主机id,整数</span></span><br><span class="line"><span class="comment">#开启二进制日志,并且名称为 /var/lib/mysql/mysql-bin.***</span></span><br><span class="line"><span class="comment"># 如果是个路径则,保存到该路径下(log-bin=/var/log/mysql-bin.log -&gt; /var/log/mysql-bin.***)</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="comment">### as master ###</span></span><br><span class="line"><span class="built_in">read</span>-only=<span class="number">0</span> <span class="comment">#主机读写权限,读写都可以</span></span><br><span class="line"></span><br><span class="line">binlog-do-db=CoamDatabase <span class="comment">#记录日志的数据库:需要的备份数据,多个写多行</span></span><br><span class="line">binlog-do-db=CoamInfo</span><br><span class="line">binlog-do-db=CoamSNS</span><br><span class="line">binlog-do-db=form</span><br><span class="line">binlog-do-db=CommonData</span><br><span class="line">binlog-do-db=Wordpress</span><br><span class="line">binlog-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">binlog-ignore-db=mysql <span class="comment">#不记录日志的数据库:不需要备份的数据库,多个写多行</span></span><br><span class="line">binlog-ignore-db=<span class="built_in">test</span></span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line">binlog-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自增字段奇数递增,防止冲突(1, 11, 21, ...,)</span></span><br><span class="line">auto-increment-increment = <span class="number">10</span> <span class="comment"># 每次递增的步长</span></span><br><span class="line">auto-increment-offset = <span class="number">1</span> <span class="comment"># 初始值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### as slave ###</span></span><br><span class="line"><span class="comment">###</span></span><br><span class="line"><span class="comment">###############################################################</span></span><br></pre></td></tr></table></figure>
<p>重启 Mysql 是配置生效,可以看到主(43.241.222.110) Mysql  增加了两个文件 mysql-bin.000001 和 mysql-bin.index </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Tue May <span class="number">17</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">52</span> yzhang@coam:/data/home/data/mysql$ ls</span><br><span class="line">auto.cnf         client-key.pem  coam.pid    ib_buffer_pool  ibtmp1           performance_schema  server-key.pem</span><br><span class="line">ca-key.pem       CoamDatabase    CoamSNS     ibdata1         IM_Ejabberd      private_key.pem     sys</span><br><span class="line">ca.pem           coam.err        CommonData  ib_logfile0     mysql            public_key.pem      <span class="built_in">test</span></span><br><span class="line">client-cert.pem  CoamInfo        forum       ib_logfile1     mysqld_safe.pid  server-cert.pem     Wordpress</span><br><span class="line">Tue May <span class="number">17</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">52</span> yzhang@coam:/data/home/data/mysql$ sudo service mysql restart       ======&gt; 重启 Mysql 数据库服务</span><br><span class="line">Tue May <span class="number">17</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">52</span> yzhang@coam:/data/home/data/mysql$ ls</span><br><span class="line">auto.cnf         CoamDatabase  CommonData      ib_logfile1       mysql-bin.<span class="number">000002</span>  performance_schema  sys</span><br><span class="line">ca-key.pem       coam.err      forum           ibtmp1            mysql-bin.<span class="number">000003</span>  private_key.pem     <span class="built_in">test</span></span><br><span class="line">ca.pem           CoamInfo      ib_buffer_pool  IM_Ejabberd       mysql-bin.<span class="number">000004</span>  public_key.pem      Wordpress</span><br><span class="line">client-cert.pem  coam.pid      ibdata1         mysql             mysql-bin.index   server-cert.pem</span><br><span class="line">client-key.pem   CoamSNS       ib_logfile0     mysql-bin.<span class="number">000001</span>  mysqld_safe.pid   server-key.pem</span><br></pre></td></tr></table></figure>
<p>– 注意,这里因为配置有问题重启过几次 mysql 导致生成 [mysql-bin.000001 mysql-bin.000002 mysql-bin.000003 mysql-bin.000004] 等几个文件,不过不影响后续步骤执行</p>
<p>先锁定 (hello) 数据库 - 不要退出 mysql shell</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;</span><br></pre></td></tr></table></figure>
<p>然后新开一个终端,导出数据库,我这里只需要导出 hello 数据库, 如果你有多个数据库作为初态的话, 需要导出所有这些数据库:( 这里为了便于测试,我先不导出 forum 数据库,后续测试单独补加同步数据库)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --master-data -uroot -p hello &gt; hello.sql</span><br><span class="line">mysqldump -u username -p password --databases CoamDatabase CoamInfo CoamSNS CommonData Wordpress IM_Ejabberd &gt;backup.sql</span><br></pre></td></tr></table></figure>
<p>查看主服务器的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">             File: mysql-bin.<span class="number">000005</span></span><br><span class="line">         Position: <span class="number">154</span></span><br><span class="line">     Binlog_Do_DB: CoamDatabase,CoamInfo,CoamSNS,forum,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Binlog_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>然后查看A服务器的 binary 日志位置,记下 Position 和 File 的值.</p>
<p>主服务器已经做完了, 可以解除锁定了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>
<ol>
<li>设置从服务器 B 需要复制的数据库<br>打开从服务器 B 的 Mysql 配置文件 <em>/etc/mysql/my.cnf</em></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line"><span class="comment">####################################################################</span></span><br><span class="line">server-id=<span class="number">2</span></span><br><span class="line"><span class="built_in">log</span>-bin=mysql-bin</span><br><span class="line"></span><br><span class="line"><span class="comment">### as master ###</span></span><br><span class="line"><span class="comment">### as slave ###</span></span><br><span class="line">replicate-do-db=CoamDatabase <span class="comment">#只复制某个库,多个写多行</span></span><br><span class="line">replicate-do-db=CoamInfo</span><br><span class="line">replicate-do-db=CoamSNS</span><br><span class="line">replicate-do-db=form</span><br><span class="line">replicate-do-db=CommonData</span><br><span class="line">replicate-do-db=Wordpress</span><br><span class="line">replicate-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">replicate-ignore-db=mysql <span class="comment">#不复制某个库</span></span><br><span class="line">replicate-ignore-db=<span class="built_in">test</span></span><br><span class="line">replicate-ignore-db=information_schema</span><br><span class="line">replicate-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line">relay-log=mysqld-relay-bin <span class="comment"># 开启日志中继</span></span><br><span class="line"><span class="built_in">log</span>-slave-updates <span class="comment"># slave 将复制事件写进自己的二进制日志</span></span><br><span class="line"><span class="comment">#5.5</span></span><br><span class="line"><span class="comment">#log-slave-updates = ON</span></span><br><span class="line"><span class="comment">#5.1</span></span><br><span class="line"><span class="comment">#log-slave-updates = 1</span></span><br><span class="line"><span class="comment">###############################################################</span></span><br></pre></td></tr></table></figure>
<p>重启 Mysql 是配置生效,可以看到从(42.96.194.60) Mysql  也相应的增加了两个文件 mysql-bin.000001 和 mysql-bin.index </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Tue May <span class="number">17</span> <span class="number">11</span>:<span class="number">07</span>:<span class="number">14</span> yzhang@coam:/data/home/data/mysql$ ls</span><br><span class="line">auto.cnf    client-cert.pem  coam.pid        ib_logfile0  mysql               private_key.pem  server-key.pem</span><br><span class="line">ca-key.pem  client-key.pem   ib_buffer_pool  ib_logfile1  mysqld_safe.pid     public_key.pem   sys</span><br><span class="line">ca.pem      coam.err         ibdata1         ibtmp1       performance_schema  server-cert.pem</span><br><span class="line">Tue May <span class="number">17</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">52</span> yzhang@coam:/data/home/data/mysql$ sudo service mysql restart       ======&gt; 重启 Mysql 数据库服务</span><br><span class="line">Tue May <span class="number">17</span> <span class="number">11</span>:<span class="number">08</span>:<span class="number">40</span> yzhang@coam:/data/home/data/mysql$ ls</span><br><span class="line">auto.cnf    client-cert.pem  coam.pid        ib_logfile0  mysql             mysqld_safe.pid     public_key.pem   sys</span><br><span class="line">ca-key.pem  client-key.pem   ib_buffer_pool  ib_logfile1  mysql-bin.<span class="number">000001</span>  performance_schema  server-cert.pem</span><br><span class="line">ca.pem      coam.err         ibdata1         ibtmp1       mysql-bin.index   private_key.pem     server-key.pem</span><br></pre></td></tr></table></figure>
<p>导入从主服务器导出的数据库 hello,然后</p>
<p>导入 master 导出的数据库:</p>
<p>分别创建需要导入的数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE CoamDatabase DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE DATABASE CoamInfo DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE DATABASE CoamSNS DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE DATABASE CommonData DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE DATABASE Wordpress DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line">mysql&gt; CREATE DATABASE IM_Ejabberd DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">source</span> backup.sql;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下方式分别导入数据库</span></span><br><span class="line">mysql -uroot -p CoamDatabase &lt; backup.sql</span><br><span class="line">mysql -uroot -p CoamInfo &lt; backup.sql</span><br><span class="line">mysql -uroot -p CoamSNS &lt; backup.sql</span><br><span class="line">mysql -uroot -p CommonData &lt; backup.sql</span><br><span class="line">mysql -uroot -p Wordpress &lt; backup.sql</span><br><span class="line">mysql -uroot -p IM_Ejabberd &lt; backup.sql</span><br></pre></td></tr></table></figure>
<ol>
<li>在从 slave 服务器配置连接 master 信息:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; slave stop;</span><br><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">-&gt; MASTER_HOST=<span class="string">'43.241.222.110'</span>, //主服务器的IP地址</span><br><span class="line">-&gt; MASTER_USER=<span class="string">'syBackup'</span>, //同步数据库的用户</span><br><span class="line">-&gt; MASTER_PASSWORD=<span class="string">'******'</span>, //同步数据库的密码</span><br><span class="line">-&gt; MASTER_CONNECT_RETRY=<span class="number">60</span>,  // 如果从服务器发现主服务器断掉,重新连接的时间差(秒)</span><br><span class="line">-&gt; MASTER_LOG_FILE=<span class="string">'mysql-bin.000001'</span>, //主服务器二进制日志的文件名(前面要求记住的 File 参数)</span><br><span class="line">-&gt; MASTER_LOG_POS=<span class="number">98</span>; //日志文件的开始位置(前面要求记住的 Position 参数)</span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST=<span class="string">'43.241.222.110'</span>, MASTER_USER=<span class="string">'syBackup'</span>, MASTER_PASSWORD=<span class="string">'******'</span>, MASTER_CONNECT_RETRY=<span class="number">60</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000005'</span>, MASTER_LOG_POS=<span class="number">154</span>;</span><br><span class="line">mysql &gt; slave start;</span><br></pre></td></tr></table></figure>
<p>重启 master, slave:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure>
<p>查看 slave 状态:</p>
<p>进入从服务器 slave mysql:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">            Slave_IO_State: Connecting to master</span><br><span class="line">                Master_Host: <span class="number">43.241</span>.<span class="number">222.110</span></span><br><span class="line">                Master_User: syBackup</span><br><span class="line">                Master_Port: <span class="number">3306</span></span><br><span class="line">            Connect_Retry: <span class="number">60</span></span><br><span class="line">            Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">        Read_Master_Log_Pos: <span class="number">98</span></span><br><span class="line">            Relay_Log_File: mysqld-relay-bin.<span class="number">000001</span></span><br><span class="line">            Relay_Log_Pos: <span class="number">98</span></span><br><span class="line">    Relay_Master_Log_File: mysql-bin.<span class="number">000001</span></span><br><span class="line">        Slave_IO_Running: Yes</span><br><span class="line">        Slave_SQL_Running: Yes</span><br><span class="line">            Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line">wik,trac,wzjp_net</span><br><span class="line">        Exec_Master_Log_Pos: <span class="number">98</span></span><br><span class="line">            Relay_Log_Space: <span class="number">98</span></span><br><span class="line">            Until_Log_Pos: <span class="number">0</span></span><br><span class="line">    Seconds_Behind_Master: NULL</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>注意一定要有下面两项(IO线程和SQL线程),没有的话查看错误日志(less /var/log/mysqld.log):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>
<p>如果显示这个状态 则稍等一会儿</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br></pre></td></tr></table></figure>
<p>测试 master 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use hello;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table <span class="built_in">test</span>(id int);</span><br><span class="line">mysql&gt; insert int <span class="built_in">test</span> <span class="built_in">set</span> id=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">mysql&gt; show master status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">            File: mysql-bin.<span class="number">000002</span>  <span class="comment"># 注意这里</span></span><br><span class="line">        Position: <span class="number">276</span>    <span class="comment"># 注意这里</span></span><br><span class="line">    Binlog_Do_DB:</span><br><span class="line">CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line">Binlog_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line">wik,trac,wzjp_net</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>测试 slave 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use hello;</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_<span class="keyword">in</span>_hello |</span><br><span class="line">+-----------------+</span><br><span class="line">| <span class="built_in">test</span>            | </span><br><span class="line">+-----------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    <span class="number">1</span> | </span><br><span class="line">+------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">            Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                Master_Host: <span class="number">43.241</span>.<span class="number">222.110</span></span><br><span class="line">                Master_User: syBackup</span><br><span class="line">                Master_Port: <span class="number">3306</span></span><br><span class="line">            Connect_Retry: <span class="number">60</span></span><br><span class="line">            Master_Log_File: mysql-bin.<span class="number">000002</span>  <span class="comment"># 跟 master 一样</span></span><br><span class="line">        Read_Master_Log_Pos: <span class="number">276</span>  <span class="comment"># 跟 master 一样</span></span><br><span class="line">            Relay_Log_File: mysqld-relay-bin.<span class="number">000003</span></span><br><span class="line">            Relay_Log_Pos: <span class="number">413</span></span><br><span class="line">    Relay_Master_Log_File: mysql-bin.<span class="number">000002</span></span><br><span class="line">        Slave_IO_Running: Yes</span><br><span class="line">        Slave_SQL_Running: Yes</span><br><span class="line">            Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line">wik,trac,wzjp_net</span><br><span class="line">                Last_Errno: <span class="number">0</span></span><br><span class="line">                Last_Error: </span><br><span class="line">            Skip_Counter: <span class="number">0</span></span><br><span class="line">        Exec_Master_Log_Pos: <span class="number">276</span></span><br><span class="line">            Relay_Log_Space: <span class="number">413</span></span><br><span class="line">    Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>主A服务器从B服务器配置就已经顺利完成了 –A从B主</p>
<hr>
<h4 id="二-下面开始配置从A服务器主B服务器"><a href="#二-下面开始配置从A服务器主B服务器" class="headerlink" title="二. 下面开始配置从A服务器主B服务器"></a>二. 下面开始配置从A服务器主B服务器</h4><ul>
<li>从服务器 A: 43.241.222.110</li>
<li>主服务器 B: 42.96.194.60</li>
</ul>
<p>一、设置主服务器 A 需要复制的数据库<br>打开主服务器 B 的 Mysql 配置文件 <em>/etc/mysql/my.cnf</em> 并添加以下配置项</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################################################</span></span><br><span class="line"><span class="setting">server-id=<span class="value"><span class="number">2</span></span></span></span><br><span class="line"><span class="setting">log-bin=<span class="value">mysql-bin</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">### as master ###</span></span><br><span class="line"><span class="setting">read-only=<span class="value"><span class="number">0</span> #主机读写权限,读写都可</span></span></span><br><span class="line"></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">CoamDatabase #记录日志的数据库:需要的备份数据,多个写多行</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">CoamInfo</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">CoamSNS</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">form</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">CommonData</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">Wordpress</span></span></span><br><span class="line"><span class="setting">binlog-do-db=<span class="value">IM_Ejabberd</span></span></span><br><span class="line"></span><br><span class="line"><span class="setting">binlog-ignore-db=<span class="value">mysql #不记录日志的数据库:不需要备份的数据库,多个写多行</span></span></span><br><span class="line"><span class="setting">binlog-ignore-db=<span class="value">test</span></span></span><br><span class="line"><span class="setting">binlog-ignore-db=<span class="value">information_schema</span></span></span><br><span class="line"><span class="setting">binlog-ignore-db=<span class="value">performance_schema</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自增字段奇数递增,防止冲突(1, 3, 5, ...,)</span></span><br><span class="line"><span class="setting">auto-increment-increment = <span class="value"><span class="number">10</span> # 每次递增的步长</span></span></span><br><span class="line"><span class="setting">auto-increment-offset = <span class="value"><span class="number">2</span> # 初始值</span></span></span><br><span class="line"><span class="comment">### as slave ###</span></span><br><span class="line"><span class="comment"># 之前配置过,这里保持不变</span></span><br><span class="line"><span class="comment">#######################################################################</span></span><br></pre></td></tr></table></figure>
<p>重启 mysql: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serivce mysqld restart</span><br></pre></td></tr></table></figure>
<p>在主 B 服务器(master)下创建给从A服务器 (slave)登录用的用户名密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class="string">'syBackup'</span>@<span class="string">'43.241.222.110'</span> IDENTIFIED BY <span class="string">'******'</span>;</span><br><span class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;</span><br><span class="line">mysql&gt; show master status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">         File: mysql-bin.<span class="number">000003</span></span><br><span class="line">         Position: <span class="number">468</span></span><br><span class="line">     Binlog_Do_DB: CoamDatabase,CoamInfo,CoamSNS,forum,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Binlog_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line">mysql&gt; UNLOCK TABLES;</span><br></pre></td></tr></table></figure>
<hr>
<p>在从服务器 A 的服务器配置登陆主服务器 B 中创建的复制用户登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; slave stop;</span><br><span class="line">mysql&gt;  CHANGE MASTER TO MASTER_HOST=<span class="string">'42.96.194.60'</span>, MASTER_USER=<span class="string">'syBackup'</span>, MASTER_PASSWORD=<span class="string">'yafei312'</span>, MASTER_CONNECT_RETRY=<span class="number">60</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000004, MASTER_LOG_POS=46702'</span>;</span><br><span class="line">mysql&gt; slave start;</span><br></pre></td></tr></table></figure>
<p>修改从服务器A的 Mysql 配置文件 <em>/etc/mysql/my.cnf</em> 从配置信息</p>
<p>打开从服务器 A 的 Mysql 配置文件 <em>/etc/mysql/my.cnf</em> 并添加以下配置项</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">### as master ###</span><br><span class="line"></span><br><span class="line">### as slave ###</span><br><span class="line">replicate-do-db=CoamDatabase #只复制某个库,多个写多行</span><br><span class="line">replicate-do-db=CoamInfo</span><br><span class="line">replicate-do-db=CoamSNS</span><br><span class="line">replicate-do-db=form</span><br><span class="line">replicate-do-db=CommonData</span><br><span class="line">replicate-do-db=Wordpress</span><br><span class="line">replicate-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">replicate-ignore-db=mysql #不复制某个库</span><br><span class="line">replicate-ignore-db=test</span><br><span class="line">replicate-ignore-db=information_schema</span><br><span class="line">replicate-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line">relay-log=mysqld-relay-bin # 开启日志中继</span><br><span class="line">log-slave-updates # slave将复制事件写进自己的二进制日志</span><br><span class="line">######################################################################</span><br></pre></td></tr></table></figure>
<p>重启主服务器A、B并测试插入测试更新数据</p>
<p>从 A 服务器 43.241.222.110</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>
<hr>
<p>最后的 A 服务器 配置文件 <em>/etc/mysql/my.cnf</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#######################################################</span><br><span class="line">server-id=1 #主机id,整数</span><br><span class="line">#开启二进制日志,并且名称为 /var/lib/mysql/mysql-bin.***</span><br><span class="line"># 如果是个路径则,保存到该路径下(log-bin=/var/log/mysql-bin.log -&gt; /var/log/mysql-bin.***)</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">### as master ###</span><br><span class="line">read-only=0 #主机读写权限,读写都可以</span><br><span class="line"></span><br><span class="line">binlog-do-db=CoamDatabase #记录日志的数据库:需要的备份数据,多个写多行</span><br><span class="line">binlog-do-db=CoamInfo</span><br><span class="line">binlog-do-db=CoamSNS</span><br><span class="line">binlog-do-db=form</span><br><span class="line">binlog-do-db=CommonData</span><br><span class="line">binlog-do-db=Wordpress</span><br><span class="line">binlog-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">binlog-ignore-db=mysql #不记录日志的数据库:不需要备份的数据库,多个写多行</span><br><span class="line">binlog-ignore-db=test</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line">binlog-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line"># 自增字段奇数递增,防止冲突(1, 11, 21, ...,)</span><br><span class="line">auto-increment-increment = 10 # 每次递增的步长</span><br><span class="line">auto-increment-offset = 1 # 初始值</span><br><span class="line"></span><br><span class="line">### as slave ###</span><br><span class="line">replicate-do-db=CoamDatabase #只复制某个库,多个写多行</span><br><span class="line">replicate-do-db=CoamInfo</span><br><span class="line">replicate-do-db=CoamSNS</span><br><span class="line">replicate-do-db=form</span><br><span class="line">replicate-do-db=CommonData</span><br><span class="line">replicate-do-db=Wordpress</span><br><span class="line">replicate-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">replicate-ignore-db=mysql #不复制某个库</span><br><span class="line">replicate-ignore-db=test</span><br><span class="line">replicate-ignore-db=information_schema</span><br><span class="line">replicate-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line">relay-log=mysqld-relay-bin # 开启日志中继</span><br><span class="line">log-slave-updates # slave将复制事件写进自己的二进制日志</span><br><span class="line">#5.5</span><br><span class="line">#log-slave-updates = ON</span><br><span class="line">#5.1</span><br><span class="line">#log-slave-updates = 1</span><br><span class="line">#######################################################</span><br></pre></td></tr></table></figure>
<p>最后的 B 服务器配置文件 <em>/etc/mysql/my.cnf</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">###############################################################</span><br><span class="line">server-id=2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">### as master ###</span><br><span class="line">read-only=0 #主机读写权限,读写都可以</span><br><span class="line"></span><br><span class="line">binlog-do-db=CoamDatabase #记录日志的数据库:需要的备份数据,多个写多行</span><br><span class="line">binlog-do-db=CoamInfo</span><br><span class="line">binlog-do-db=CoamSNS</span><br><span class="line">binlog-do-db=form</span><br><span class="line">binlog-do-db=CommonData</span><br><span class="line">binlog-do-db=Wordpress</span><br><span class="line">binlog-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">binlog-ignore-db=mysql #不记录日志的数据库:不需要备份的数据库,多个写多行</span><br><span class="line">binlog-ignore-db=test</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line">binlog-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line"># 自增字段奇数递增,防止冲突(2, 12, 22, ...,)</span><br><span class="line">auto-increment-increment = 10 # 每次递增的步长</span><br><span class="line">auto-increment-offset = 2 # 初始值</span><br><span class="line">### as slave ###</span><br><span class="line">replicate-do-db=CoamDatabase #只复制某个库,多个写多行</span><br><span class="line">replicate-do-db=CoamInfo</span><br><span class="line">replicate-do-db=CoamSNS</span><br><span class="line">replicate-do-db=form</span><br><span class="line">replicate-do-db=CommonData</span><br><span class="line">replicate-do-db=Wordpress</span><br><span class="line">replicate-do-db=IM_Ejabberd</span><br><span class="line"></span><br><span class="line">replicate-ignore-db=mysql #不复制某个库</span><br><span class="line">replicate-ignore-db=test</span><br><span class="line">replicate-ignore-db=information_schema</span><br><span class="line">replicate-ignore-db=performance_schema</span><br><span class="line"></span><br><span class="line">relay-log=mysqld-relay-bin # 开启日志中继</span><br><span class="line">log-slave-updates # slave将复制事件写进自己的二进制日志</span><br><span class="line">#5.5</span><br><span class="line">#log-slave-updates = ON</span><br><span class="line">#5.1</span><br><span class="line">#log-slave-updates = 1</span><br><span class="line">###############################################################</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ol>
<li>安装MySQL.首先要在两台服务器上安装MySQL,完成之后应该确认能否两台服务器能否互相访问. 这是因为缺省的 my.cnf 设置有 bind-address = 127.0.0.1,这条语句应该被注释掉.</li>
<li>创建账号.数据库中缺省的帐户的host值是localhost,所以应该创建一个可以远端访问的帐号.比如:</li>
</ol>
<p>root@’%’ or root@10.x.x.x</p>
<hr>
<h3 id="Mysql双机热备份日常维护及问题分析"><a href="#Mysql双机热备份日常维护及问题分析" class="headerlink" title="Mysql双机热备份日常维护及问题分析"></a>Mysql双机热备份日常维护及问题分析</h3><a id="more"></a>
<p>好不容易搭建了Mysql服务器双机热备份后,在 phpMyAdmin 管理后台更新数据,出现如下错误:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql Unsafe statement written to the binary <span class="built_in">log</span> using statement format since BINLOG_FORMAT = STATEMENT. Statement is unsafe because it uses a UDF <span class="built_in">which</span> may not <span class="built_in">return</span> the same value on the slave.</span><br></pre></td></tr></table></figure>
<p>因为我使用mysql2redis和udf搭建了Mysql自动同步到Redis数据库缓存,双机热备份后,在本地服务器可以及时更新当前主机的Redis数据,但是从服务器不能自动触发udf更新操作导致出现上面的错误</p>
<p>首先需要使用命令 show slave status\G; 检查两个数据库的的同步状态是否正确,保证没有 插入. 更新. 打开临时表 等操作,在两个服务器执行以下命令</p>
<p>在两个服务器上停止从服务的任务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">flush tables with <span class="built_in">read</span> lock;</span><br></pre></td></tr></table></figure>
<p>在两个主服务器上执行锁表并修改日志记录方式:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flush tables with <span class="built_in">read</span> lock;</span><br><span class="line"><span class="built_in">set</span> global binlog_format=<span class="string">'MIXED'</span>;</span><br><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>
<p>最后在两个服务器执行以下命令启动从服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>
<p>重新修改,发现没有出现以上错误 参考 <a href="http://serverfault.com/questions/316691/mysql-binlog-format-dilemma" target="_blank" rel="external">MySQL binlog format dilemma?</a></p>
<p>Statement 【基于SQL语句的复制(statement-based replication, SBR)】</p>
<p>Row 【基于行的复制(row-based replication, RBR)】 方式不会出现某些特定情况下的存储过程,或function,以及trigger的调用和触发无法被正确复制的问题.</p>
<p>MIXED 【混合模式复制 (mixed-based replication, MBR)】是以上(Statement和Row)两者的综合.在Mixed模式下,MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式,也就是在Statement和Row之间选择一种.新版本中的Statment level还是和以前一样,仅仅记录执行的语句.而新版本的MySQL中队row level模式也被做了优化,并不是所有的修改都会以row level来记录,像遇到表结构变更的时候就会以statement模式来记录,如果sql语句确实就是update或者delete等修改数据的语句,那么还是会记录所有行的变更.<br>参考 MYSQL复制参数 binlog_format<br>由于将 binlog_format 改成 MIXED 或者 ROW 不会导致出错,但是不会再从服务器执行 udf 配置的redis复制命令(测试可以触发执行在当前数据库中的表的修改操作),所以考虑将双主机的Mysql服务器的Redis修改操作统一提交到一台主Redis服务器,搭建Redis主从同步机制</p>
<hr>
<h3 id="日常问题分析"><a href="#日常问题分析" class="headerlink" title="日常问题分析"></a>日常问题分析</h3><p>某次不小心改了B服务器的一条数据后,A服务器一直没有更新过来,反过来A服务器修改B服务器没有更新,为了保持数据一致,于是各种折腾,清空表. 删除表再重建仍是没有解决问题并导致其他数据库的表也不能顺利同步</p>
<ul>
<li>在 A 服务器上查看 A的从服务同步状态,提示如下错误</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"> *************************** <span class="number">1</span>. row ***************************</span><br><span class="line"> Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line"> Master_Host: <span class="number">42.96</span>.<span class="number">194.60</span></span><br><span class="line"> Master_User: syBackup</span><br><span class="line"> Master_Port: <span class="number">3306</span></span><br><span class="line"> Connect_Retry: <span class="number">60</span></span><br><span class="line"> Master_Log_File: mysql-bin.<span class="number">000028</span></span><br><span class="line"> Read_Master_Log_Pos: <span class="number">31876</span></span><br><span class="line"> Relay_Log_File: mysqld-relay-bin.<span class="number">000063</span></span><br><span class="line"> Relay_Log_Pos: <span class="number">26437</span></span><br><span class="line"> Relay_Master_Log_File: mysql-bin.<span class="number">000028</span></span><br><span class="line"> Slave_IO_Running: Yes</span><br><span class="line"> Slave_SQL_Running: No</span><br><span class="line"> Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line"> wik,trac,wzjp_net Replicate_Do_Table:</span><br><span class="line"> Replicate_Ignore_Table:</span><br><span class="line"> Replicate_Wild_Do_Table:</span><br><span class="line"> Replicate_Wild_Ignore_Table:</span><br><span class="line"> Last_Errno: <span class="number">1062</span></span><br><span class="line"> Last_Error: Error <span class="string">'Duplicate entry '</span><span class="number">2</span><span class="string">' for key '</span>PRIMARY<span class="string">''</span> on query. Default database: <span class="string">'Com</span><br><span class="line"> monData'</span>. Query: <span class="string">'INSERT INTO `CommonData`.`Sarah_PictureManager` (`pictureId`, `pictureImgShow`, `pictureGroup`, `pictureTitle`, `pictureSubTitle`, `picturePostil`, `pubTime`) VALUES (NULL, '</span><span class="string">', '</span><span class="string">', '</span>尚无标注<span class="string">', '</span>尚无子标注<span class="string">', '</span>尚未批注<span class="string">', CURRENT_TIMESTAMP)'</span> Skip_Counter: <span class="number">0</span></span><br><span class="line"> Exec_Master_Log_Pos: <span class="number">30844</span></span><br><span class="line"> Relay_Log_Space: <span class="number">27806</span></span><br><span class="line"> Until_Condition: None</span><br><span class="line"> Until_Log_File:</span><br><span class="line"> Until_Log_Pos: <span class="number">0</span></span><br><span class="line"> Master_SSL_Allowed: No</span><br><span class="line"> Master_SSL_CA_File:</span><br><span class="line"> Master_SSL_CA_Path:</span><br><span class="line"> Master_SSL_Cert:</span><br><span class="line"> Master_SSL_Cipher:</span><br><span class="line"> Master_SSL_Key:</span><br><span class="line"> Seconds_Behind_Master: NULL</span><br><span class="line"> Master_SSL_Verify_Server_Cert: No</span><br><span class="line"> Last_IO_Errno: <span class="number">0</span></span><br><span class="line"> Last_IO_Error:</span><br><span class="line"> Last_SQL_Errno: <span class="number">1062</span></span><br><span class="line"> Last_SQL_Error: Error <span class="string">'Duplicate entry '</span><span class="number">2</span><span class="string">' for key '</span>PRIMARY<span class="string">''</span> on query. Default database: <span class="string">'Com</span><br><span class="line"> monData'</span>. Query: <span class="string">'INSERT INTO `CommonData`.`Sarah_PictureManager` (`pictureId`, `pictureImgShow`, `pictureGroup`, `pictureTitle`, `pictureSubTitle`, `picturePostil`, `pubTime`) VALUES (NULL, '</span><span class="string">', '</span><span class="string">', '</span>尚无标注<span class="string">', '</span>尚无子标注<span class="string">', '</span>尚未批注<span class="string">', CURRENT_TIMESTAMP)'</span> Replicate_Ignore_Server_Ids:</span><br><span class="line"> Master_Server_Id: <span class="number">2</span></span><br><span class="line"> Master_UUID: <span class="number">1</span>c0ea40b-<span class="number">56</span>be-<span class="number">11</span>e5-<span class="number">8329</span>-<span class="number">00163</span>e043c4f</span><br><span class="line"> Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line"> SQL_Delay: <span class="number">0</span></span><br><span class="line"> SQL_Remaining_Delay: NULL</span><br><span class="line"> Slave_SQL_Running_State:</span><br><span class="line"> Master_Retry_Count: <span class="number">86400</span></span><br><span class="line"> Master_Bind:</span><br><span class="line"> Last_IO_Error_Timestamp:</span><br><span class="line"> Last_SQL_Error_Timestamp: <span class="number">150922</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">35</span></span><br><span class="line"> Master_SSL_Crl:</span><br><span class="line"> Master_SSL_Crlpath:</span><br><span class="line"> Retrieved_Gtid_Set:</span><br><span class="line"> Executed_Gtid_Set:</span><br><span class="line"> Auto_Position: <span class="number">0</span></span><br><span class="line"> <span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line"> No query specified</span><br></pre></td></tr></table></figure>
<ul>
<li>在 B 的服务器同样查看B服务器的从服务器同步状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"> *************************** <span class="number">1</span>. row ***************************</span><br><span class="line"> Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line"> Master_Host: <span class="number">43.241</span>.<span class="number">222.110</span></span><br><span class="line"> Master_User: syBackup</span><br><span class="line"> Master_Port: <span class="number">3306</span></span><br><span class="line"> Connect_Retry: <span class="number">60</span></span><br><span class="line"> Master_Log_File: mysql-bin.<span class="number">000022</span></span><br><span class="line"> Read_Master_Log_Pos: <span class="number">52902</span></span><br><span class="line"> Relay_Log_File: mysqld-relay-bin.<span class="number">000065</span></span><br><span class="line"> Relay_Log_Pos: <span class="number">283</span></span><br><span class="line"> Relay_Master_Log_File: mysql-bin.<span class="number">000017</span></span><br><span class="line"> Slave_IO_Running: Yes</span><br><span class="line"> Slave_SQL_Running: No</span><br><span class="line"> Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line"> wik,trac,wzjp_net Replicate_Do_Table:</span><br><span class="line"> Replicate_Ignore_Table:</span><br><span class="line"> Replicate_Wild_Do_Table:</span><br><span class="line"> Replicate_Wild_Ignore_Table:</span><br><span class="line"> Last_Errno: <span class="number">1050</span></span><br><span class="line"> Last_Error: Error <span class="string">'Table '</span>Sarah_PictureManager<span class="string">' already exists'</span> on query. Default database</span><br><span class="line"> : <span class="string">'CommonData'</span>. Query: <span class="string">'RENAME TABLE `CommonData`.`Sarah_PictureManager` TO `test`.`Sarah_PictureManager`'</span></span><br><span class="line"> Skip_Counter: <span class="number">0</span></span><br><span class="line"> Exec_Master_Log_Pos: <span class="number">120</span></span><br><span class="line"> Relay_Log_Space: <span class="number">12643</span></span><br><span class="line"> Until_Condition: None</span><br><span class="line"> Until_Log_File:</span><br><span class="line"> Until_Log_Pos: <span class="number">0</span></span><br><span class="line"> Master_SSL_Allowed: No</span><br><span class="line"> Master_SSL_CA_File:</span><br><span class="line"> Master_SSL_CA_Path:</span><br><span class="line"> Master_SSL_Cert:</span><br><span class="line"> Master_SSL_Cipher:</span><br><span class="line"> Master_SSL_Key:</span><br><span class="line"> Seconds_Behind_Master: NULL</span><br><span class="line"> Master_SSL_Verify_Server_Cert: No</span><br><span class="line"> Last_IO_Errno: <span class="number">0</span></span><br><span class="line"> Last_IO_Error:</span><br><span class="line"> Last_SQL_Errno: <span class="number">1050</span></span><br><span class="line"> Last_SQL_Error: Error <span class="string">'Table '</span>Sarah_PictureManager<span class="string">' already exists'</span> on query. Default database</span><br><span class="line"> : <span class="string">'CommonData'</span>. Query: <span class="string">'RENAME TABLE `CommonData`.`Sarah_PictureManager` TO `test`.`Sarah_PictureManager`'</span></span><br><span class="line"> Replicate_Ignore_Server_Ids:</span><br><span class="line"> Master_Server_Id: <span class="number">1</span></span><br><span class="line"> Master_UUID: <span class="number">811367</span>ec-<span class="number">52</span>b9-<span class="number">11</span>e5<span class="operator">-a</span>8f5-<span class="number">0022</span>f75<span class="built_in">fc</span>65a</span><br><span class="line"> Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line"> SQL_Delay: <span class="number">0</span></span><br><span class="line"> SQL_Remaining_Delay: NULL</span><br><span class="line"> Slave_SQL_Running_State:</span><br><span class="line"> Master_Retry_Count: <span class="number">86400</span></span><br><span class="line"> Master_Bind:</span><br><span class="line"> Last_IO_Error_Timestamp:</span><br><span class="line"> Last_SQL_Error_Timestamp: <span class="number">150922</span> <span class="number">17</span>:<span class="number">40</span>:<span class="number">05</span></span><br><span class="line"> Master_SSL_Crl:</span><br><span class="line"> Master_SSL_Crlpath:</span><br><span class="line"> Retrieved_Gtid_Set:</span><br><span class="line"> Executed_Gtid_Set:</span><br><span class="line"> Auto_Position: <span class="number">0</span></span><br><span class="line"> <span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line"> No query specified</span><br></pre></td></tr></table></figure>
<p>均有如下相同的错误状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: No <span class="comment"># 正常的为Yes</span></span><br></pre></td></tr></table></figure>
<p>于是猜想是双服务器的数据库不能同步,并且有很多修改,不知从哪里开始恢复,网上建议</p>
<p>有时候由于BUG或者在从服务器执行了写操作可能会造成键重复错误,错误信息如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error ‘Duplicate entry ...’ <span class="keyword">for</span> key ... on query</span><br></pre></td></tr></table></figure>
<p>此时最好手动确认并删除从服务器上的无效数据,然后从主服务器复制正确数据,如果错误仍然不能解决,可以在从服务器使用 <em>SET GLOBAL sql_slave_skip_counter</em> ,如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL sql_slave_skip_counter = <span class="number">1</span>;  <span class="comment"># 客户端运行,用来跳过几个事件,只有当同步进程出现错误而停止的时候才可以执行.</span></span><br><span class="line">mysql&gt; START SLAVE; <span class="comment"># 记得一定要执行,不然后续查看 从服务器的状态不会及时更新过来</span></span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line"> Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line"> Master_Host: <span class="number">43.241</span>.<span class="number">222.110</span></span><br><span class="line"> Master_User: syBackup</span><br><span class="line"> Master_Port: <span class="number">3306</span></span><br><span class="line"> Connect_Retry: <span class="number">60</span></span><br><span class="line"> Master_Log_File: mysql-bin.<span class="number">000022</span></span><br><span class="line"> Read_Master_Log_Pos: <span class="number">52902</span></span><br><span class="line"> Relay_Log_File: mysqld-relay-bin.<span class="number">000083</span></span><br><span class="line"> Relay_Log_Pos: <span class="number">2158</span></span><br><span class="line"> Relay_Master_Log_File: mysql-bin.<span class="number">000022</span></span><br><span class="line"> Slave_IO_Running: Yes</span><br><span class="line"> Slave_SQL_Running: Yes</span><br><span class="line"> Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line">wik,trac,wzjp_net Replicate_Do_Table: </span><br><span class="line"> Replicate_Ignore_Table: </span><br><span class="line"> Replicate_Wild_Do_Table: </span><br><span class="line"> Replicate_Wild_Ignore_Table: </span><br><span class="line"> Last_Errno: <span class="number">0</span></span><br><span class="line"> Last_Error: </span><br><span class="line"> Skip_Counter: <span class="number">0</span></span><br><span class="line"> Exec_Master_Log_Pos: <span class="number">52902</span></span><br><span class="line"> Relay_Log_Space: <span class="number">2495</span></span><br><span class="line"> Until_Condition: None</span><br><span class="line"> Until_Log_File: </span><br><span class="line"> Until_Log_Pos: <span class="number">0</span></span><br><span class="line"> Master_SSL_Allowed: No</span><br><span class="line"> Master_SSL_CA_File: </span><br><span class="line"> Master_SSL_CA_Path: </span><br><span class="line"> Master_SSL_Cert: </span><br><span class="line"> Master_SSL_Cipher: </span><br><span class="line"> Master_SSL_Key: </span><br><span class="line"> Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line"> Last_IO_Errno: <span class="number">0</span></span><br><span class="line"> Last_IO_Error: </span><br><span class="line"> Last_SQL_Errno: <span class="number">0</span></span><br><span class="line"> Last_SQL_Error: </span><br><span class="line"> Replicate_Ignore_Server_Ids: </span><br><span class="line"> Master_Server_Id: <span class="number">1</span></span><br><span class="line"> Master_UUID: <span class="number">811367</span>ec-<span class="number">52</span>b9-<span class="number">11</span>e5<span class="operator">-a</span>8f5-<span class="number">0022</span>f75<span class="built_in">fc</span>65a</span><br><span class="line"> Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line"> SQL_Delay: <span class="number">0</span></span><br><span class="line"> SQL_Remaining_Delay: NULL</span><br><span class="line"> Slave_SQL_Running_State: Slave has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span><br><span class="line"> Master_Retry_Count: <span class="number">86400</span></span><br><span class="line"> Master_Bind: </span><br><span class="line"> Last_IO_Error_Timestamp: </span><br><span class="line"> Last_SQL_Error_Timestamp: </span><br><span class="line"> Master_SSL_Crl: </span><br><span class="line"> Master_SSL_Crlpath: </span><br><span class="line"> Retrieved_Gtid_Set: </span><br><span class="line"> Executed_Gtid_Set: </span><br><span class="line"> Auto_Position: <span class="number">0</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>注:如果有多个错误,可能需要依次循环执行多次(提醒:主从服务器数据可能因此不一致,遇到这样的情况可以使用 pt-table-checksum 和 pt-table-sync 检查并修复从服务器数据).</p>
<p>发现没有错误则停止继续执行  SET GLOBAL sql_slave_skip_counter = 1;  否则执行过多会导致新插入的数据不会更新(未验证)</p>
<hr>
<ul>
<li>问题:主从复制不止何故停止了,我该怎么办?</li>
</ul>
<p>答案:复制错误多半是因为日志错误引起的,所以首先要搞清楚是主日志错误还是中继日志错误,从错误信息里一般就能判断,如果不能可以使用类似下面的mysqlbinlog命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysqlbinlog &lt;MASTER_BINLOG_FILE&gt; &gt; /dev/null</span><br><span class="line">shell&gt; mysqlbinlog &lt;RELAY_BINLOG_FILE&gt; &gt; /dev/null</span><br></pre></td></tr></table></figure>
<p>如果没有错误,则不会有任何输出,反之如果有错误,则会显示出来.</p>
<ul>
<li>同步执行SQL错误,同步自动终止问题</li>
</ul>
<p>在一台服务器更新了一个字段值,但是在从服务器没有更新过来,于是在从服务器查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: <span class="number">42.96</span>.<span class="number">194.60</span></span><br><span class="line">                  Master_User: syBackup</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql-bin.<span class="number">000007</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">176357</span></span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.<span class="number">000005</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">4776</span></span><br><span class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000007</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line">          Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">1062</span></span><br><span class="line">                   Last_Error: Could not execute Write_rows event on table Wordpress.wp_options; , Error_code: <span class="number">1062</span>; handler error HA_ERR_FOUND_DUPP_KEY; the event<span class="string">'s master log mysql-bin.000007, end_log_pos 4884</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 4563</span><br><span class="line">              Relay_Log_Space: 174245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 1062</span><br><span class="line">               Last_SQL_Error: Could not execute Write_rows event on table Wordpress.wp_options; , Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event'</span>s master <span class="built_in">log</span> mysql-bin.<span class="number">000007</span>, end_<span class="built_in">log</span>_pos <span class="number">4884</span></span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">2</span></span><br><span class="line">                  Master_UUID: <span class="number">1</span>e14bbca-<span class="number">1</span>b46-<span class="number">11</span>e6<span class="operator">-a</span>21a-<span class="number">00163</span>e043c4f</span><br><span class="line">             Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State:</span><br><span class="line">           Master_Retry_Count: <span class="number">86400</span></span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp: <span class="number">160518</span> <span class="number">23</span>:<span class="number">30</span>:<span class="number">42</span></span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: <span class="number">0</span></span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>发现 <em>Slave_SQL_Running: No</em> 问题 并且有一条SQL执行错误 <em>Last_SQL_Error: Could not execute Write_rows event on table Wordpress.wp_options; , Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event’s master log mysql-bin.000007, end_log_pos 4884</em> </p>
<ol>
<li>执行如下语句跳过一个 SQL 语句执行错误,问题解决,如果有多个错误,以下可以多执行几次</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE; SET GLOBAL SQL_SLAVE_SKIP_COUNTER=<span class="number">1</span>; START SLAVE;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果在配置文件设定自动跳过 SQL 语句执行错误自动终止功能,可以配置 <em>/etc/mysql/my.cnf</em></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slave-skip-errors = <span class="number">1062</span></span><br></pre></td></tr></table></figure>
<p>以上配置全局忽略1062错误 <a href="http://www.ducea.com/2008/02/13/mysql-skip-duplicate-replication-errors/" target="_blank" rel="external">MySQL Skip Duplicate Replication Errors</a><br><a href="http://blog.arganzheng.me/posts/mysql-replication-errors-fixed.html" target="_blank" rel="external">记一次MySQL主从同步错误处理</a></p>
<ul>
<li>如果是主日志错误,需要手动找到正确的日志信息,重新 CHANGE MASTER TO 即可:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">       MASTER_LOG_FILE=<span class="string">'&lt;GOOD_LOG_FILE&gt;'</span>,</span><br><span class="line">       MASTER_LOG_POS=&lt;GOOD_LOG_POS&gt;;</span><br><span class="line">mysql&gt; START SLAVE;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是中继日志错误,只要在从服务器使用SHOW SLAVE STATUS结果中的日志信息重新CHANGE MASTER TO即可,系统会抛弃当前的中继日志,重新下载:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">       MASTER_LOG_FILE=<span class="string">'&lt;Relay_Master_Log_File&gt;'</span>,</span><br><span class="line">       MASTER_LOG_POS=&lt;Exec_Master_Log_Pos&gt;;</span><br><span class="line">       </span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'&lt;Relay_Master_Log_File&gt;'</span>, MASTER_LOG_POS=&lt;Exec_Master_Log_Pos&gt;;</span><br><span class="line"></span><br><span class="line">mysql&gt; START SLAVE;</span><br></pre></td></tr></table></figure>
<p>至于为什么使用的是 Relay_Master_Log_File &amp; Exec_Master_Log_Pos,参见概述.</p>
<ul>
<li>MySQL主从失败, 错误 <em>Got fatal error 1236</em> 解决方法</li>
</ul>
<ol>
<li>在从服务器</li>
</ol>
<ul>
<li>查看当前服务器作为从服务器同步状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">yzhang@coam:~$ mysql -u zhangyanxi -p</span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">               Slave_IO_State:</span><br><span class="line">                  Master_Host: <span class="number">42.96</span>.<span class="number">194.60</span></span><br><span class="line">                  Master_User: syBackup</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">60</span></span><br><span class="line">              Master_Log_File: mysql-bin.<span class="number">000005</span>, MASTER_LOG_POS=<span class="number">154</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">4</span></span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.<span class="number">000001</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">4</span></span><br><span class="line">        Relay_Master_Log_File: mysql-bin.<span class="number">000005</span>, MASTER_LOG_POS=<span class="number">154</span></span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line">          Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">4</span></span><br><span class="line">              Relay_Log_Space: <span class="number">154</span></span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: <span class="number">1236</span></span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">2</span></span><br><span class="line">                  Master_UUID: <span class="number">1</span>e14bbca-<span class="number">1</span>b46-<span class="number">11</span>e6<span class="operator">-a</span>21a-<span class="number">00163</span>e043c4f</span><br><span class="line">             Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line">                    SQL_Delay: <span class="number">0</span></span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Master_Retry_Count: <span class="number">86400</span></span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp: <span class="number">160518</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">06</span></span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: <span class="number">0</span></span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>
<p>可以看到 <em>Slave_IO_State</em> 和 <em>Slave_IO_Running</em> 都不正常,而 <em>Read_Master_Log_Pos</em> 为 4</p>
<ul>
<li>查看从服务器错误日志文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yzhang@coam:~$ sudo vi /data/home/data/mysql/coam.err</span><br><span class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">18</span>T03:<span class="number">29</span>:<span class="number">06.947349</span>Z <span class="number">30</span> [ERROR] Error reading packet from server <span class="keyword">for</span> channel <span class="string">''</span>: Could not find first <span class="built_in">log</span> file name <span class="keyword">in</span> binary <span class="built_in">log</span> index file (server_errno=<span class="number">1236</span>)</span><br><span class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">18</span>T03:<span class="number">29</span>:<span class="number">06.947405</span>Z <span class="number">30</span> [ERROR] Slave I/O <span class="keyword">for</span> channel <span class="string">''</span>: , Error_code: <span class="number">1236</span></span><br><span class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">18</span>T03:<span class="number">29</span>:<span class="number">06.947417</span>Z <span class="number">30</span> [Note] Slave I/O thread exiting <span class="keyword">for</span> channel <span class="string">''</span>, <span class="built_in">read</span> up to <span class="built_in">log</span> <span class="string">'mysql-bin.000005, MASTER_LOG_POS=154'</span>, position <span class="number">4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在主服务器查看主服务器同步状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status\G;</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line">         File: mysql-bin.<span class="number">000005</span></span><br><span class="line">         Position: <span class="number">468</span></span><br><span class="line">     Binlog_Do_DB: CoamDatabase,CoamInfo,CoamSNS,forum,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Binlog_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>回到从服务器设置同步位置-记住,不要在这个时候重启主服务器,否则 <em>File: mysql-bin.000005</em> 会改变</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'mysql-bin.000005'</span>, MASTER_LOG_POS=<span class="number">468</span>;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"> *************************** <span class="number">1</span>. row ***************************</span><br><span class="line"> Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line"> Master_Host: <span class="number">42.96</span>.<span class="number">194.60</span></span><br><span class="line"> Master_User: syBackup</span><br><span class="line"> Master_Port: <span class="number">3306</span></span><br><span class="line"> Connect_Retry: <span class="number">60</span></span><br><span class="line"> Master_Log_File: mysql-bin.<span class="number">000005</span></span><br><span class="line"> Read_Master_Log_Pos: <span class="number">468</span></span><br><span class="line"> Relay_Log_File: mysqld-relay-bin.<span class="number">000065</span></span><br><span class="line"> Relay_Log_Pos: <span class="number">283</span></span><br><span class="line"> Relay_Master_Log_File: mysql-bin.<span class="number">000017</span></span><br><span class="line"> Slave_IO_Running: Yes</span><br><span class="line"> Slave_SQL_Running: Yes</span><br><span class="line"> Replicate_Do_DB: CoamDatabase,CoamInfo,CoamSNS,form,CommonData,Wordpress,IM_Ejabberd</span><br><span class="line"> Replicate_Ignore_DB: mysql,<span class="built_in">test</span>,information_schema,performance_schema,collie,ding,inotseeyou_com,pi</span><br><span class="line"> wik,trac,wzjp_net Replicate_Do_Table:</span><br><span class="line"> Replicate_Ignore_Table:</span><br><span class="line"> Replicate_Wild_Do_Table:</span><br><span class="line"> Replicate_Wild_Ignore_Table:</span><br><span class="line"> Last_Errno: <span class="number">1050</span></span><br><span class="line"> Last_Error: Error <span class="string">'Table '</span>Sarah_PictureManager<span class="string">' already exists'</span> on query. Default database</span><br><span class="line"> : <span class="string">'CommonData'</span>. Query: <span class="string">'RENAME TABLE `CommonData`.`Sarah_PictureManager` TO `test`.`Sarah_PictureManager`'</span></span><br><span class="line"> Skip_Counter: <span class="number">0</span></span><br><span class="line"> Exec_Master_Log_Pos: <span class="number">120</span></span><br><span class="line"> Relay_Log_Space: <span class="number">12643</span></span><br><span class="line"> Until_Condition: None</span><br><span class="line"> Until_Log_File:</span><br><span class="line"> Until_Log_Pos: <span class="number">0</span></span><br><span class="line"> Master_SSL_Allowed: No</span><br><span class="line"> Master_SSL_CA_File:</span><br><span class="line"> Master_SSL_CA_Path:</span><br><span class="line"> Master_SSL_Cert:</span><br><span class="line"> Master_SSL_Cipher:</span><br><span class="line"> Master_SSL_Key:</span><br><span class="line"> Seconds_Behind_Master: NULL</span><br><span class="line"> Master_SSL_Verify_Server_Cert: No</span><br><span class="line"> Last_IO_Errno: <span class="number">0</span></span><br><span class="line"> Last_IO_Error:</span><br><span class="line"> Last_SQL_Errno: <span class="number">1050</span></span><br><span class="line"> Last_SQL_Error: Error <span class="string">'Table '</span>Sarah_PictureManager<span class="string">' already exists'</span> on query. Default database</span><br><span class="line"> : <span class="string">'CommonData'</span>. Query: <span class="string">'RENAME TABLE `CommonData`.`Sarah_PictureManager` TO `test`.`Sarah_PictureManager`'</span></span><br><span class="line"> Replicate_Ignore_Server_Ids:</span><br><span class="line"> Master_Server_Id: <span class="number">1</span></span><br><span class="line"> Master_UUID: <span class="number">811367</span>ec-<span class="number">52</span>b9-<span class="number">11</span>e5<span class="operator">-a</span>8f5-<span class="number">0022</span>f75<span class="built_in">fc</span>65a</span><br><span class="line"> Master_Info_File: /data/home/data/mysql/master.info</span><br><span class="line"> SQL_Delay: <span class="number">0</span></span><br><span class="line"> SQL_Remaining_Delay: NULL</span><br><span class="line"> Slave_SQL_Running_State:</span><br><span class="line"> Master_Retry_Count: <span class="number">86400</span></span><br><span class="line"> Master_Bind:</span><br><span class="line"> Last_IO_Error_Timestamp:</span><br><span class="line"> Last_SQL_Error_Timestamp: <span class="number">150922</span> <span class="number">17</span>:<span class="number">40</span>:<span class="number">05</span></span><br><span class="line"> Master_SSL_Crl:</span><br><span class="line"> Master_SSL_Crlpath:</span><br><span class="line"> Retrieved_Gtid_Set:</span><br><span class="line"> Executed_Gtid_Set:</span><br><span class="line"> Auto_Position: <span class="number">0</span></span><br><span class="line"> <span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line"> No query specified</span><br></pre></td></tr></table></figure>
<p><a href="http://truthone.blog.sohu.com/243314332.html" target="_blank" rel="external">MySQL主从失败, 错误Got fatal error 1236解决方法</a></p>
<ul>
<li>出现以下错误</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Slave SQL <span class="keyword">for</span> channel ‘’: Slave failed to initialize relay <span class="built_in">log</span> info structure from the repository, Error_code: <span class="number">1872</span></span><br></pre></td></tr></table></figure>
<p>是因为 relay-log 有问题,这时候修改从服务器mysql配置,在[mysqld]中加入relay-log-recovery=1,这样表示,服务器启动之后,删除所有已有的relay日志,重新接收主库的relay日志</p>
<p><a href="https://haofly.net/mysql-master-slave/" target="_blank" rel="external">Mysql之主从复制</a></p>
<ul>
<li>问题:主服务器宕机了,如何把从服务器提升会主服务器?</li>
</ul>
<p>答案:在一主多从的环境总,需选择数据最新的从服务器做新的主服务器.<br>如下图所示:</p>
<p>promotion</p>
<p>在一主(Server1)两从(Server2,. Server3)环境中,Server1宕机后,等到Server2和Server3把宕机前同步到的日志都执行完,比较Master_Log_File和Read_Master_Log_Pos就可以判断出谁快谁慢,<br>因为Server2从Server1同步的数据(1582)比Server3从Server1同步的数据(1493)新,所以应该提升Server2为新的主服务器,<br>那么Server3在CHANGE MASTER TO到Server2的时候应该使用什么样的参数呢?1582-1493=89,而Server2的最后的二进制日志位置是8167,所以答案是8167-89=8078.</p>
<h3 id="参考列表"><a href="#参考列表" class="headerlink" title="参考列表"></a>参考列表</h3><p><a href="http://huoding.com/2011/04/05/59" target="_blank" rel="external">MySQL复制的概述. 安装. 故障. 技巧. 工具</a><br><a href="http://blog.itpub.net/29500582/viewspace-1318552/" target="_blank" rel="external">Slave_SQL_Running: No mysql同步故障</a><br><a href="http://mysql.wingtiplabs.com/documentation/reprv7zv/repair-replication" target="_blank" rel="external">Repair Replication</a><br><a href="http://www.54it.top/archives/638" target="_blank" rel="external">MySQL主从服务器数据不同步</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/05/14/Mysql/MysqlSyncNote/">MysqlSyncNote</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 张亚飞 的个人博客">张亚飞</a></p>
        <p><span>发布时间:</span>2016年05月14日 - 17时03分</p>
        <p><span>最后更新:</span>2016年05月19日 - 16时26分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/05/14/Mysql/MysqlSyncNote/" title="MysqlSyncNote">https://coam.co/2016/05/14/Mysql/MysqlSyncNote/</a>
            <span class="copy-path" data-clipboard-text="原文: https://coam.co/2016/05/14/Mysql/MysqlSyncNote/　　作者: 张亚飞" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/05/15/Linux/LinuxCommand/">
                    LinuxCommand
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/05/14/Mysql/MysqlToRedis/">
                    MysqlToRedis
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql双机热备份"><span class="toc-number">1.</span> <span class="toc-text">Mysql双机热备份</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mysql-主从同步配置"><span class="toc-number">1.1.</span> <span class="toc-text">Mysql 主从同步配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一-A主B从"><span class="toc-number">1.2.</span> <span class="toc-text">一. A主B从</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二-下面开始配置从A服务器主B服务器"><span class="toc-number">1.3.</span> <span class="toc-text">二. 下面开始配置从A服务器主B服务器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它"><span class="toc-number">2.</span> <span class="toc-text">其它</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mysql双机热备份日常维护及问题分析"><span class="toc-number">3.</span> <span class="toc-text">Mysql双机热备份日常维护及问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日常问题分析"><span class="toc-number">4.</span> <span class="toc-text">日常问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考列表"><span class="toc-number">5.</span> <span class="toc-text">参考列表</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>






    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/05/15/Linux/LinuxCommand/" title="上一篇: LinuxCommand">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/05/14/Mysql/MysqlToRedis/" title="下一篇: MysqlToRedis">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/Erlang/InstallOTP/">InstallOTP</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/Redis/RedisSyncNote/">RedisSyncNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/16/Linux/Ubuntu/">Linux/Ubuntu</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/16/Linux/SystemInstall/">Linux/SystemInstall</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/16/Others/YL/">Others/YL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/15/Linux/LinuxCommand/">LinuxCommand</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/Mysql/MysqlSyncNote/">MysqlSyncNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/Mysql/MysqlToRedis/">MysqlToRedis</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/13/Mysql/MysqlNote/">MysqlNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/13/Mysql/MysqlSql/">MysqlSql</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/Redis/RedisNote/">RedisNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/Mongo/MongoNotes/">MongoNotes</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/09/Linux/iptables/">iptables</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/25/Android/AndroidNDK/">AndroidNDK</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/21/Design/PhotoShop/">PhotoShop 设计笔记摘要</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/15/Others/Enshrine/">Enshrine收藏</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/Others/Imagine/">【脑洞大开】你看过这样的动态图吗?——太牛了！</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/26/Linux/Linux.bashrc/">Linux.bashrc</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/24/WinScripts/WinNote/">WinNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/Android/ProGuard/">ProGuard</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/Linux/ShadowSocks/">ShadowSocks</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/19/Web/WebDesign/">WebDesign</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/Plan/FreeShareInfoIdea/">Plan/FreeShareInfoIdea</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/Phalcon/PhalconNote/">Phalcon/PhalconNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/Info/EnshrineBlogs/">Info/EnshrineBlogs</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/18/CLang/cMake/">cMake</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/13/Android/CoamApp/">CoamApp</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/30/CLang/GccNote/">GCCNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/QT/QTNote/">QTNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/CLang/DevIDENote/">DevIDENote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/24/CLang/CNote/">CNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/22/QT/Cygwin/">Cygwin</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/22/Electron/ElectronNote/">ElectronNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/21/NodeJs/CheerioNote/">CheerioNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/21/NodeJs/MochaNote/">MochaNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/20/NodeJs/WebpackNote/">WebPack 自动打包工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/20/NodeJs/GulpNote/">NodeJs/GulpNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/20/Info/hospital/">hospital</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/18/Angular/TypeScriptNote/">TypeScriptNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/17/Angular/AngularNote/">Angular 开发笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/14/Java/JavaNote/">JavaNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/13/Python/PythonNote/">PythonNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Ejabberd/EjabberdModule/">EjabberdModule</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Ejabberd/EjabberdConfigure/">EjabberdConfigure</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnRetrofit/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/PHP/PhpNote/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnLombok/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnJavaHashMap/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnJavaArray/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnGoogleGuava/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnAsyncTask/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/NodeJs/NodeJsNote/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/MongoDB/mongo-slave/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/MongoDB/mongo-replicaSet/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/MongoDB/MongoNotes/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/GPS/GPSNote/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/Rebar/">RebarNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/Mnesia/">MnesiaNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/MQTT/">MQTTNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/Lua/">LuaNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Mongo/mongo-slave/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/Erlang/">ErlangNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Erlang/Elixir/">ElixirNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Mongo/mongo-replicaSet/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Ejabberd/XMPP/">XMPPNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Ejabberd/EjabberdNote/">EjabberdNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/PHP/Composer/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/SSL/LetSSL/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/AndroidStudio/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Nginx/NginxNote/">NginxNote</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Mysql/MysqlTrigger/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/AndroidPushMQTT/">Android 推送之 MQTT</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/PHP/phpMyAdmin/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnSupportAnnotations/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnRxJava/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnRetrolambda/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnOther/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnListView/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnGradle/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnAndroidFragment/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnAndroidDesign/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnAndroidContext/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/LearnAndroid/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/EventBus/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/DebugAndroidStethoAppWithChrome/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/DebugAndroidLog/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Android/Conversations.IM/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/Java/LearnOkHttp/">Title</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/08/Http/HttpNote/">Http协议相关</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/08/Others/MarkDownNote/">MarkDown 相关</a></li></ul>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 张亚飞
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        <div class="visit">
            <span id="busuanzi_container_site_pv" style='display:none'>
                <span id="site-visit" >本站到访数: 
                    <span id="busuanzi_value_site_uv"></span>
                </span>
            </span>
            <span id="busuanzi_container_page_pv" style='display:none'>
                <span id="page-visit">, 本页阅读量: 
                    <span id="busuanzi_value_page_pv"></span>
                </span>
            </span>
        </div>
    </div>
</footer>
    </div>
    <script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>